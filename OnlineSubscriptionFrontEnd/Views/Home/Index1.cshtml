@{
    ViewData["Title"] = "Index";
}

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" type="text/css" href="~/files/assets/icon/feather/css/feather.css">
<!-- QR Code Library -->
<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

<!-- Custom JS -->
<script src="~/insoft/assets/assets/js/custom.js"></script>

<!-- jsPDF Core Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Latest html2canvas (Version 0.4.2) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.2/html2canvas.min.js"></script>

<!-- Latest html2pdf (Version 0.9.3) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.js"></script>

<!-- jsPDF AutoTable Plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.0/jspdf.plugin.autotable.min.js"></script>
 <style>
    .container {
        height: auto;
    }

    .OrgCard {
        height: auto; /* Allow content to grow */
        padding: 20px;
        overflow-y: auto; /* Ensure it doesn't block scroll */
    }

    .container {
        width: 90%;
        max-width: 1200px;
        background-color: #fff;
        border-radius: 8px;
        overflow: auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin: auto;
    }

    p {
        font-size: 15px;
    }

    .PlanDetails {
        text-align: center;
        color: white;
        background-size: cover;
        background-position: center;
        position: relative;
    }

    .content {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        padding: 20px;
    }

    .green {
        color: green;
    }

    .card {
        background-color: #f4f9ff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

        .card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }

        .card ul {
            list-style: none;
        }

            .card ul li {
                margin-bottom: 8px;
                font-size: 14px;
                color: #555;
            }

                .card ul li span {
                    font-weight: bold;
                    color: #333;
                }

    .plan {
        text-align: center;
        background-color: #034F75;
        color: white;
    }

    .infotext {
        color: #034F75;
        font-weight: 400;
        height: 14px;
        font-family: Courier New, Courier, monospace;
    }

    .labelp {
        color: white;
        font-weight: 400;
        height: 14px;
        font-family: Courier New, Courier, monospace;
    }

    /* Responsive Styles */
    @@media (max-width: 768px) {
        .content

    {
        grid-template-columns: 1fr 1fr; /* 2 columns on medium screens */
    }

    .card {
        padding: 15px;
    }

    .container {
        width: 95%;
    }

    .OrgCard {
        padding: 20px;
    }

    .SchoolInfo {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

        .SchoolInfo .imageinfo {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
        }

        .SchoolInfo .mainInfo {
            margin-left: 0;
            text-align: center;
        }

    .page-heading {
        font-size: 24px;
    }

    }

    @@media (max-width: 576px) {
        .content

    {
        grid-template-columns: 1fr; /* 1 column on small screens */
    }

    .card {
        padding: 10px;
    }

    .OrgCard {
        padding: 15px;
    }

    .SchoolInfo {
        padding: 10px;
    }

        .SchoolInfo .imageinfo {
            width: 60px;
            height: 60px;
        }

        .SchoolInfo .mainInfo p {
            font-size: 14px;
        }

    .page-heading {
        font-size: 20px;
    }

    }

    @@media (max-width: 400px) {
        .page-heading

    {
        font-size: 18px;
    }

    .card h3 {
        font-size: 16px;
    }

    .card ul li {
        font-size: 12px;
    }

    .SchoolInfo .imageinfo {
        width: 50px;
        height: 50px;
    }

    .SchoolInfo .mainInfo p {
        font-size: 12px;
    }

    }
</style>


<div class="row" style="overflow:auto;">
    <div class="py-3 py-lg-6 col-xs-2">
        <div class="container-xxl d-flex flex-wrap justify-content-between align-items-center">
            <!-- Page title section -->
            <div class="page-title d-flex flex-column justify-content-center flex-wrap me-md-3 mb-3 mb-md-0">
                <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">
                    <img src="~/assets/media/logos/LogoInsoft.png"
                         class="theme-light-show w-100px"
                         alt="Logo" />
                </h1>
            </div>

            <!-- Right section (Buttons and User Menu) -->
            <div class="d-flex align-items-center">
                <!-- New Organization Button -->
                <h6 class="fs-xl fw-bold mb-4 lead">
                    <button type="button" class="btn btn-primary addOrganization d-flex align-items-center">
                        <span class="svg-icon svg-icon-2 me-2">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect opacity="0.5" x="11.364" y="20.364" width="16" height="2" rx="1" transform="rotate(-90 11.364 20.364)" fill="currentColor"></rect>
                                <rect x="4.36396" y="11.364" width="16" height="2" rx="1" fill="currentColor"></rect>
                            </svg>
                        </span>
                        New Organization
                    </button>
                </h6>

                <!-- User Account Menu -->
                <div class="app-navbar-item ms-1 ms-md-3 ml-md-4" id="kt_header_user_menu_toggle">
                    <div class="cursor-pointer symbol symbol-35px symbol-md-40px" data-kt-menu-trigger="{default: 'click', lg: 'hover'}" data-kt-menu-attach="parent" data-kt-menu-placement="bottom-start">
                        <i class="fa-solid fa-gear fs-1 mt-3 mx-8">
                            &nbsp;
                            <span style="font-family:'Times New Roman', Times, serif;" class="UserName" hidden></span>
                        </i>
                    </div>

                    <!-- User Account Menu Dropdown -->
                    <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-800 menu-state-bg menu-state-color fw-semibold fs-6 w-100px" data-kt-menu="true">
                        <div class="menu-item">
                            <a class="menu-link signoutBtn">
                                <i class="feather icon-log-out"></i>&nbsp; Sign Out
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="updateOrganization" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="kt_modal_update_Organization" aria-hidden="true">
    <div class="modal-dialog  modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fw-bold d-flex align-items-center text-dark">
                    Edit Your Organization details
                </h2>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="row-12 mb-3">

                                <label for="newcompanyName" class=" required form-label mb-3">Company Name</label>
                                <input type="text"
                                       class="form-control form-control-sm border border-dark rounded  "
                                       id="newcompanyName" />
                            </div>
                            <div class="row-12">

                                <label for="contact" class="required form-label mb-3">Contact No.</label>
                                <input type="text" class="form-control form-control-sm border border-dark rounded  " id="newContactNumber" />

                            </div>
                        </div>
                        <div class="col-6">
                            <label for="newcompanyLogo" class=" required form-label mb-3">Company Logo:</label>
                            <div class="d-block">
                                <div class="image-input image-input-empty image-input-outline image-input-placeholder " data-kt-image-input="true">
                                    <div class="image-input-wrapper w-125px h-125px rounded">
                                        <img src="~/assets/media/logos/logo.png"
                                             id="logoValue" class="logoValue theme-light-show img-thumbnail h-100 img-fluid w-100 rounded " data-name="" />
                                    </div>
                                    <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" data-kt-image-input-action="change" data-bs-toggle="tooltip" aria-label="Change avatar" data-bs-original-title="Change avatar" data-kt-initialized="1">
                                        <i class="bi bi-pencil-fill fs-7"></i>
                                        <input type="file" name="avatar" accept=".png, .jpg, .jpeg" id="inputLogo1" />
                                        <input type="hidden" name="avatar_remove" />
                                    </label>

                                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" data-kt-image-input-action="cancel" data-bs-toggle="tooltip" aria-label="Cancel avatar" data-bs-original-title="Cancel avatar" data-kt-initialized="1">
                                        <i class="bi bi-x fs-2"></i>
                                    </span>

                                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" data-kt-image-input-action="remove" data-bs-toggle="tooltip" aria-label="Remove avatar" data-bs-original-title="Remove avatar" data-kt-initialized="1">
                                        <i class="bi bi-x fs-2"></i>
                                    </span>

                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">

                        <div class="col-lg-6 col-sm-12">
                            <label for="displayName" class="required form-label mb-3">Country</label>
                            <select class="form-select form-select-sm border border-dark rounded NewCountrySelect" id="NewCountrySelect">
                            </select>
                        </div>


                        <div class="col-lg-6 col-sm-12">
                            <label for="displayName" class="required form-label mb-3">Display Name</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded " id="newdisplayName" />
                        </div>
                        <div class="col-lg-6 col-sm-12 no-wrap col-12">
                            <label for="newinitial" class="required form-label mb-3">Initial</label>
                            <div class="flex-row input-group">
                                <div class="col-lg-3 col-sm-2 shrink-1 col-4">
                                    <input type="text" class="form-control form-control-sm  rounded border border-dark " id="newinitial" />
                                </div>
                                <div class="col-lg-4 col-sm-3 shrink-1 col-4">
                                    <input disabled type="text" class="form-control form-control-sm border border-dark rounded text-dark defaultModuleValue" id="basic-addon2" value=".intradepos.com" />

                                </div>
                                <div class="col-lg-4 col-sm-4 shrink-1 col-4">

                                    <select class="form-select form-select-sm border border-dark rounded moduleSelect" id="newmoduleSelect">
                                    </select>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-lg-6 col-sm-12">
                            <label for="newvat" class="required form-label mb-3">TPIN/PAN</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded  " id="newvat" />
                        </div>
                        <div class="col-lg-6 col-sm-12">
                            <label for="newaddress" class="required form-label mb-3">Address</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded  " id="newaddress" />
                        </div>

                    </div>

                    <div class="row mb-3">
                        <div class="col-lg-6 col-sm-12">
                            <label for="newphone" class="required form-label mb-3">Phone No.</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded  " id="newphone" />
                        </div>
                        <div class="col-lg-6 col-sm-12">
                            <label for="newEmail" class="required form-label mb-3">Email</label>
                            <input type="email" class="form-control form-control-sm border border-dark rounded  " id="newEmail" />
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-sm-12" style="display:none;">
                            <label for="newmotto" class="required form-label mb-3">Organization Motto</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded  " id="newmotto" />
                        </div>
                        <div class="col-lg-6 col-sm-12">
                            <label for="newWebsite" class="form-label mb-3">Website</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded " id="newWebsite" />
                        </div>
                    </div>
                    <div class="d-flex flex-stack pt-10">
                        <div class="me-2">
                            <button type="button" class="btn btn-lg btn-light-primary me-3" data-bs-dismiss="modal"
                                    aria-label="Close">
                                <span class="svg-icon svg-icon-3 me-1">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect opacity="0.5" x="6" y="11" width="13" height="2" rx="1" fill="currentColor"></rect>
                                        <path d="M8.56569 11.4343L12.75 7.25C13.1642 6.83579 13.1642 6.16421 12.75 5.75C12.3358 5.33579 11.6642 5.33579 11.25 5.75L5.70711 11.2929C5.31658 11.6834 5.31658 12.3166 5.70711 12.7071L11.25 18.25C11.6642 18.6642 12.3358 18.6642 12.75 18.25C13.1642 17.8358 13.1642 17.1642 12.75 16.75L8.56569 12.5657C8.25327 12.2533 8.25327 11.7467 8.56569 11.4343Z" fill="currentColor"></path>
                                    </svg>
                                </span>
                                Back
                            </button>
                        </div>

                        <div>
                            <button type="button" class="btn btn-lg btn-primary d-inline-block" id="updateDetails">
                                <span class="indicator-label">
                                    Update
                                    <span class="svg-icon svg-icon-3 ms-2 me-0">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <rect opacity="0.5" x="18" y="13" width="13" height="2" rx="1" transform="rotate(-180 18 13)" fill="currentColor"></rect>
                                            <path d="M15.4343 12.5657L11.25 16.75C10.8358 17.1642 10.8358 17.8358 11.25 18.25C11.6642 18.6642 12.3358 18.6642 12.75 18.25L18.2929 12.7071C18.6834 12.3166 18.6834 11.6834 18.2929 11.2929L12.75 5.75C12.3358 5.33579 11.6642 5.33579 11.25 5.75C10.8358 6.16421 10.8358 6.83579 11.25 7.25L15.4343 11.4343C15.7467 11.7467 15.7467 12.2533 15.4343 12.5657Z" fill="currentColor"></path>
                                        </svg>
                                    </span>
                                    <span class="indicator-progress">
                                        Please wait...
                                        <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                                    </span>
                                </span>
                            </button>@*
                                <button type="submit" class="btn btn-lg btn-primary d-none" data-kt-stepper-action="next">Submit
                                <span class="svg-icon svg-icon-3 ms-1 me-0">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect opacity="0.5" x="18" y="13" width="13" height="2" rx="1" transform="rotate(-180 18 13)" fill="currentColor"></rect>
                                <path d="M15.4343 12.5657L11.25 16.75C10.8358 17.1642 10.8358 17.8358 11.25 18.25C11.6642 18.6642 12.3358 18.6642 12.75 18.25L18.2929 12.7071C18.6834 12.3166 18.6834 11.6834 18.2929 11.2929L12.75 5.75C12.3358 5.33579 11.6642 5.33579 11.25 5.75C10.8358 6.16421 10.8358 6.83579 11.25 7.25L15.4343 11.4343C15.7467 11.7467 15.7467 12.2533 15.4343 12.5657Z" fill="currentColor"></path>
                                </svg> *@
                            @* </span> *@
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog  modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fw-bold d-flex align-items-center text-dark">
                    Add Your Organization details
                </h2>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="row-12 mb-3">

                                <label for="companyName" class=" required form-label mb-3">Company Name</label>
                                <input type="text"
                                       class="form-control form-control-sm border border-dark rounded  "
                                       id="companyName" />
                            </div>
                            <div class="row-12">

                                <label for="contact" class="required form-label mb-3">Contact No.</label>
                                <input type="text" class="form-control form-control-sm border border-dark rounded  " id="ContactNumber" />

                            </div>
                        </div>
                        <div class="col-6">
                            <label for="companyLogo" class="form-label mb-3">Company Logo:</label>
                            <div class="d-block">
                                <div class="image-input image-input-empty image-input-outline image-input-placeholder " data-kt-image-input="true">
                                    <div class="image-input-wrapper w-125px h-125px rounded">
                                        <img src="~/assets/media/logos/logo.png"
                                             class="logoValue theme-light-show img-thumbnail h-100 img-fluid w-100 rounded "
                                             data-name="" required />
                                    </div>
                                    <label class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" data-kt-image-input-action="change" data-bs-toggle="tooltip" aria-label="Change avatar" data-bs-original-title="Change avatar" data-kt-initialized="1">
                                        <i class="bi bi-pencil-fill fs-7"></i>
                                        <input type="file" name="avatar" accept=".png, .jpg, .jpeg" id="inputLogo" />
                                        <input type="hidden" name="avatar_remove" />
                                    </label>

                                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" data-kt-image-input-action="cancel" data-bs-toggle="tooltip" aria-label="Cancel avatar" data-bs-original-title="Cancel avatar" data-kt-initialized="1">
                                        <i class="bi bi-x fs-2"></i>
                                    </span>

                                    <span class="btn btn-icon btn-circle btn-active-color-primary w-25px h-25px bg-body shadow" data-kt-image-input-action="remove" data-bs-toggle="tooltip" aria-label="Remove avatar" data-bs-original-title="Remove avatar" data-kt-initialized="1">
                                        <i class="bi bi-x fs-2"></i>
                                    </span>

                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">

                        <div class="col-lg-6 col-sm-12">
                            <label for="displayName" class="required form-label mb-3">Country</label>
                            <select class="form-select form-select-sm border border-dark rounded CountrySelect" id="CountrySelect">
                                <option value="">----Select Country---</option>
                            </select>
                        </div>



                        <div class="col-lg-6 col-sm-12">
                            <label for="displayName" class="required form-label mb-3">Display Name</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded " id="displayName" />
                        </div>
                        <div class="col-lg-12 col-sm-12 no-wrap col-12">
                            <label for="initial" class="required form-label mb-3">Initial</label>
                            <div class="flex-row input-group">
                                <div class="col-lg-2 col-sm-3 shrink-1 col-4" style="margin-left:2px;">
                                    <input type="text" class="form-control form-control-sm  rounded border border-dark " id="initial" />
                                </div>
                                <div class="col-lg-4 col-sm-4 shrink-1 col-4" style="margin-left:2px;">
                                    <input disabled type="text" class="form-control form-control-sm border border-dark rounded text-dark defaultModuleValue" id="basic-addon2" value=".intradepos.com" />

                                </div>
                                <div class="col-lg-4 col-sm-4 shrink-1 col-4" style="margin-left:2px;">

                                    <select class="form-select form-select-sm border border-dark rounded moduleSelect" id="moduleSelect">
                                    </select>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-lg-6 col-sm-12">
                            <label for="vat" class="required form-label mb-3">TPIN/PAN</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded  " id="vat" />
                        </div>
                        <div class="col-lg-6 col-sm-12">
                            <label for="address" class="required form-label mb-3">Address</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded  " id="address" />
                        </div>

                    </div>

                    <div class="row mb-3">
                        <div class="col-lg-6 col-sm-12">
                            <label for="phone" class="required form-label mb-3">Phone No.</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded  " id="phone" />
                        </div>
                        <div class="col-lg-6 col-sm-12">
                            <label for="Email" class="required form-label mb-3">Email</label>
                            <input type="email" class="form-control form-control-sm border border-dark rounded  " id="Email" />
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-sm-12" style="display:none;">
                            <label for="motto" class="required form-label mb-3">Organization Motto</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded  " id="motto" />
                        </div>
                        <div class="col-lg-6 col-sm-12">
                            <label for="Website" class="form-label mb-3">Website</label>
                            <input type="text" class="form-control form-control-sm border border-dark rounded " id="Website" />
                        </div>
                    </div>
                    <div class="d-flex flex-stack pt-10">
                        <div class="me-2">
                            <button type="button" class="btn btn-lg btn-light-primary me-3" data-bs-dismiss="modal"
                                    aria-label="Close">
                                <span class="svg-icon svg-icon-3 me-1">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect opacity="0.5" x="6" y="11" width="13" height="2" rx="1" fill="currentColor"></rect>
                                        <path d="M8.56569 11.4343L12.75 7.25C13.1642 6.83579 13.1642 6.16421 12.75 5.75C12.3358 5.33579 11.6642 5.33579 11.25 5.75L5.70711 11.2929C5.31658 11.6834 5.31658 12.3166 5.70711 12.7071L11.25 18.25C11.6642 18.6642 12.3358 18.6642 12.75 18.25C13.1642 17.8358 13.1642 17.1642 12.75 16.75L8.56569 12.5657C8.25327 12.2533 8.25327 11.7467 8.56569 11.4343Z" fill="currentColor"></path>
                                    </svg>
                                </span>
                                Back
                            </button>
                        </div>

                        <div>
                            @* <button type="button" class="btn btn-lg btn-primary d-inline-block" id="updateDetails">
                                <span class="indicator-label">
                                Update
                                <span class="svg-icon svg-icon-3 ms-2 me-0">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect opacity="0.5" x="18" y="13" width="13" height="2" rx="1" transform="rotate(-180 18 13)" fill="currentColor"></rect>
                                <path d="M15.4343 12.5657L11.25 16.75C10.8358 17.1642 10.8358 17.8358 11.25 18.25C11.6642 18.6642 12.3358 18.6642 12.75 18.25L18.2929 12.7071C18.6834 12.3166 18.6834 11.6834 18.2929 11.2929L12.75 5.75C12.3358 5.33579 11.6642 5.33579 11.25 5.75C10.8358 6.16421 10.8358 6.83579 11.25 7.25L15.4343 11.4343C15.7467 11.7467 15.7467 12.2533 15.4343 12.5657Z" fill="currentColor"></path>
                                </svg>
                                </span>
                                <span class="indicator-progress">
                                Please wait...
                                <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                                </span>
                                </button> *@
                            <button class="btn btn-lg btn-primary" id="submitDetails" data-kt-stepper-action="next">
                                Submit
                                <span class="svg-icon svg-icon-3 ms-1 me-0">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <rect opacity="0.5" x="18" y="13" width="13" height="2" rx="1" transform="rotate(-180 18 13)" fill="currentColor"></rect>
                                        <path d="M15.4343 12.5657L11.25 16.75C10.8358 17.1642 10.8358 17.8358 11.25 18.25C11.6642 18.6642 12.3358 18.6642 12.75 18.25L18.2929 12.7071C18.6834 12.3166 18.6834 11.6834 18.2929 11.2929L12.75 5.75C12.3358 5.33579 11.6642 5.33579 11.25 5.75C10.8358 6.16421 10.8358 6.83579 11.25 7.25L15.4343 11.4343C15.7467 11.7467 15.7467 12.2533 15.4343 12.5657Z" fill="currentColor"></path>
                                    </svg>
                                </span>
                            </button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<div id="payinvoice">

</div>

<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" style="width:100%; max-width:1500px;">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">
                    Status of<b> <span class="userEmail"></span></b>&nbsp;'s subscription for <b><span class="productN"></span></b>  <br />
                </h1>

                <button type="button" class="btn-close  btn-danger" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div class="tabbable">

                    <ul class="nav nav-tabs md-tabs padding-12" id="myTab4" role="tablist">
                        <li class="nav-item ">
                            <a class="nav-link active ExtendTab " data-bs-toggle="tab" href="#Extend" role="tab" aria-expanded="false">Extend </a>
                        </li>
                        <li class=" nav-item ">
                            <a class="nav-link LogTab" data-bs-toggle="tab" href="#Log" role="tab" aria-expanded="true">Subscription Log</a>
                        </li>
                    </ul>

                    <div class="tab-content" style="margin-top:20px;">
                        <!-- Subscription Details Tab -->
                        <div id="Log" class="tab-pane table-responsive">
                            <table id="cLogTable" class="table-fixed table DGV table-striped table-bordered table-hover tblclear" style="width: 100%; border-collapse: separate; padding: 0px;">
                                <thead>
                                    <tr style="background-color: #0b3b56; color: white;">
                                        <th>S.N.</th>
                                        <th class="center">Print</th>
                                        <th>FonePay Trace Id</th>
                                        <th class="center">Product Name</th>
                                        <th class="center">Subscription Type</th>
                                        <th class="center">Issued date</th>
                                        <th class="center">Next Due Date</th>
                                        <th class="center">Remarks</th>
                                        <th class="center">Payment Remarks</th>
                                        <th class="center">Payment Method</th>
                                        <th class="center">Payment Partner</th>
                                        <th class="center">Amount</th>
                                        <th class="center">Reference Id</th>
                                        <th class="center hideme">Machine Key</th>
                                        <th class="center">License Key</th>


                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Add your data rows here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Extend the Plan Tab -->
                        <div id="Extend" class="tab-pane active" style="padding: 20px; background-color: #f4f7fc; border-radius: 8px;">
                            <div class="cardWrapper" style="display: flex; justify-content: space-between; gap: 20px; padding: 20px;">

                                <!-- Left Side Panel -->
                                <div class="d-none d-sm-block leftSide" style="width: 25%; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                                    <p style="font-size: 14px; color: #333; line-height: 1.6;">
                                        <strong>Note:</strong><br>
                                        The payment from Bank Deposit takes up to three days from our side to verify your subscription. Please have patience and enjoy your journey with us!
                                    </p>
                                </div>

                                <!-- Main Card Section -->
                                <div class="cardProceed col-12 col-sm-6" style="padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                                    <form>
                                        <div class="row" style="margin-bottom: 15px;">
                                            <label style="font-size: 16px; font-weight: bold; color: #333;">Current Plan: <span class="currentPlan" style="color: #888;">None</span></label>
                                            <label style="font-size: 16px; font-weight: bold; color: #333;">Due Date: <span class="currentPlanEdate" style="color: red;">__/__/____</span></label>
                                            <label style="font-size: 16px; font-weight: bold; color: #333;" hidden>Remaining Plan (No. of Days):&nbsp;&nbsp;&nbsp;<span class="remainingDaysinCPlan red" style="color: red;"></span> Days out of <span class="TotalDaysInCurrentPlan red" style="color: red;">30</span> Days</label>
                                        </div>
                                        <div class="row" style="margin-bottom: 15px;">
                                            <label style="font-size: 16px; font-weight: bold; color: #333;">Machine Key:</label>
                                            <input type="text" class="form-control MachineKey" disabled required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                                        </div>

                                        <div class="row" style="margin-bottom: 15px;">
                                            <label style="font-size: 16px; font-weight: bold; color: #333;">Select a Package:</label>
                                            <select class="selectedPackages" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                                            </select>
                                        </div>

                                        <div class="row" style="margin-bottom: 15px;">
                                            <label style="font-size: 16px; font-weight: bold; color: #333;">Next Due Date:</label>
                                            <input type="date" class="form-control expiryDate" disabled style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                                        </div>

                                        <div class="row" style="margin-bottom: 15px;">
                                            <label style="font-size: 16px; font-weight: bold; color: #333;">Amount:</label>
                                            <input type="text" class="form-control Amount" disabled required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                                        </div>

                                        <div class="row" style="margin-bottom: 15px;">
                                            <label style="font-size: 16px; font-weight: bold; color: #333;">Remarks:</label>
                                            <input type="text" class="form-control rem" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                                            <input type="text" id="custid" hidden />
                                            <input type="text" id="prodid" hidden />
                                        </div>

                                        @*  <div class="row" style="margin-bottom: 15px;">
                                            <label style="font-size: 16px; font-weight: bold; color: #333;">Payment Method:</label>
                                            <div class="payment-methods" style="display: flex; gap: 20px;">
                                                <div class="payment-option" data-value="0" style="border:1px solid black;">
                                                    <input type="radio" name="payment" id="upload" />
                                                    <label for="upload" style="font-size: 14px; color: #333; display: flex; align-items: center;">
                                                        Bank Deposit <img src="~/files/assets/images/upload.svg" alt="Upload" style="width: 20px; margin-left: 5px;" />
                                                    </label>
                                                </div>
                                                <div class="payment-option" data-value="3" style="vertical-align: middle; border:1px solid black;">
                                                    <input type="radio" name="payment" id="fonepay" />
                                                    <label for="fonepay" style="font-size: 14px; color: #333; display: flex; align-items: center;">
                                                        <img src="~/files/assets/images/fonepay-payment-service-limited43.png" alt="Fonepay" style="width: 30px; margin-top: 20px;" />
                                                        FonePay
                                                    </label>
                                                </div>
                                            </div>
                                        </div> *@


                                        <div class="row mb-3 PaymentDiv">
                                            <label class="col-12" style="font-size: 16px; font-weight: bold; color: #333;">Payment Method:</label>
                                            <div class="payment-methods d-flex flex-wrap justify-content-center gap-3 col-12">
                                                <!-- Bank Deposit with Drag-and-Drop Upload -->
                                                <div class="payment-option col-lg-4 col-md-6 col-sm-12 p-3" data-value="0" style="border: 1px solid black; text-align: center;">
                                                    <input type="radio" class="form-control d-none" value="file" name="payment" id="upload" />
                                                    <label for="upload" class="w-100" style="font-size: 14px; color: #333; display: block; margin-bottom: 10px;">
                                                        Bank Deposit
                                                    </label>
                                                    <div id="uploadArea" class="gethere" style="border: 2px dashed #999; padding: 20px; position: relative; background-color: #f9f9f9; cursor: pointer;">
                                                        <p style="font-size: 14px; color: #666;">Drag & Drop or <span style="color: #007bff; text-decoration: underline;">browse files</span></p>
                                                        <span class="uploadedinfo" style="color: green; font-weight: bold;"></span>
                                                        <input type="file" class="form-control" id="fileInput" accept="image/*" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;" />
                                                    </div>
                                                </div>

                                                <!-- FonePay Option -->
                                                <div class="payment-option pyFonepay col-lg-4 col-md-6 col-sm-12 p-3" data-value="3" style="border: 1px solid black; text-align: center;">
                                                    <input type="radio" class="form-control d-none" value="fonepay" name="payment" id="fonepay" />
                                                    <label for="fonepay" class="w-100" style="font-size: 14px; color: #333; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                        <img src="~/files/assets/images/fonepay_payments_fatafat.png" alt="Fonepay" style="width: 180px; height: 100px; vertical-align:middle;" />
                                                        <span>FonePay</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row" id="file-upload" style="display:none; margin-bottom: 15px;">
                                            <input type="file" class="file" id="fileInput" data-filename="" style="padding: 10px;" hidden />
                                            <p id="fileError" style="color:red; display:none;"></p>
                                        </div>

                                        <div class="row center" id="qr-code" style="display:none; margin-bottom: 15px;">
                                            <div id="generated-qr" style="text-align:center;"></div>
                                        </div>

                                        <div class="row">
                                            <button class="btn btn-sm btn-success btnExtendPlan" style="width: 100%; padding: 12px; font-size: 16px; border-radius: 4px; border: none; background-color: #28a745; color: white; cursor: pointer;">
                                                Proceed &nbsp;<i class="feather icon-save"></i>
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Right Side Panel -->
                                <div class="d-none d-sm-block rightSide" style="width: 25%; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                                    <p style="font-size: 14px; color: #333; line-height: 1.6;">
                                        <strong>Note:</strong><br>
                                        Your subscription to the respective Product will be updated as soon as we receive your payment made through FonePay QR.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>


<!-- PDF Preview Modal -->
<div id="pdfPreviewModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Subscription Extension Receipt Preview</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- PDF Preview embedded here -->
                <iframe id="pdfPreview" width="100%" height="500px"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" id="downloadReceiptButton" class="btn btn-primary">Download Receipt</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for QR -->
<div class="modal fade" id="QRModal" style="vertical-align:middle;" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" style="width:90%;">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">
                    Scan the QR below to proceed to payment
                </h1>
                <button type="button" class="btn btn-close btn-danger" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Using Bootstrap grid classes to make the image responsive -->
                <div class="row justify-content-center mb-4">
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                        <div class="btn btn-sm w-100">
                            <img src="~/files/assets/images/fonepay-payment-service-limited43.png" class="img-fluid" alt="Fonepay Image" />
                        </div>
                    </div>
                </div>

                <!-- QR code section -->
                <div id="generated-qr-container" class="d-flex justify-content-center">
                    <!-- QR Code will be dynamically inserted here -->
                    <div id="generated-qr"></div>
                </div>

                <h1 class="text-center modal-title fs-5" id="hehe">
                    <br /> INSOFT RESEARCH AND DEVELOPMENT<br /> an amount of <span id="AmountQr"></span>
                </h1>
            </div>
        </div>
    </div>
</div>


<!-- Modal for Remaining Days less than 5 -->
<div class="modal fade" id="QRModal5" style="vertical-align:middle;" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" style="width:90%;">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h1 class="modal-title fs-5" id="exampleModalLabel">
                    Your Subscription is critical!! Please pay for further use of our software!!
                </h1>
                <button type="button" class="btn btn-close btn-danger" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 class="text-center">  <span>This QR amounts to<b> Rs <span class="AmCurPlan">99,999</span> </b>for the extension of your current plan.</span></h4>


                <div id="generated-qr-container" class="d-flex justify-content-center">
                    <!-- QR Code will be dynamically inserted here -->

                    <div id="generated-qr"></div>
                </div>
            </div>
            <div class="modal-footer">
                Please call us for further assistance!!
            </div>



        </div>
    </div>
</div>
@* 
<div class="OrgCard card p-5" style="border:1px solid black;overflow-y:auto;">
    <div class="card-header" style="background-color:#E4DBFF;">
        <div class="SchoolInfo center" style="display: flex; align-items: center; ">
            <!-- Circular image with border -->
            <div class="imageinfo" style="flex-shrink: 0; width: 72px; height: 72px; border-radius: 50%;display: flex; justify-content: center; align-items: center; background-color: lightgray;">
                <!-- Placeholder for image -->
                <img src="~/files/assets/images/employee.png" class="img-fluid" style="max-width: 100px;" />
            </div>
            <!-- Main info with centered text -->
            <div class="mainInfo" style="margin-left: 20px; text-align: center; flex-grow: 1;">
                <p style="font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 24px; line-height: 72px;"><span class="UserOrg"></span></p>
                <p style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 18px;"><span class="UserOrgAdd"></span></p>
                <p style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 18px;"><a class="UserOrgurl"></a></p>
            </div>
        </div>
    </div>
    <div class="buttonsHere">
    </div>

    <div class="bindHere">
    </div>
</div>
 *@

<div class="mainContent">


    <script>
        $(document).ready(async function () {
         $(".defaultModuleValue").val('inschoolerp.com');
          LoadCountries();
        // Update value on change event
        $(document).on("change", ".moduleSelect", function () {
            var val = $(this).find("option:selected").attr("data-site");
            $(".defaultModuleValue").val(val);
        });
            var amountFetchedFromServer = 0;
            function LoadCountries() {
                var a = AjaxCallWithoutDataNoAsync("/Customer/getCountries");
                var aa = JSON.parse(a);
                var countries = JSON.parse(aa);

                var countrySelect = $('#CountrySelect');
                countrySelect.empty();
                countrySelect.append('<option value="">----Select Country---</option>');

                countries.forEach(function (country) {
                    countrySelect.append('<option value="' + country.NumericIsoCode + '">' + country.Name + '</option>');
                });
            }
            await GetOrganizations();
            //loadplansforcustomerandproduct(51,7);  //hea

             $('.viewSub').each(async function () {
                var id = $(this).attr("data-custid");
                var ProductId = $(this).attr("data-productid");
                $("#custid").val(id);
                $("#prodid").val(ProductId);

                var userEmail = $(this).attr("data-useremail");
                $("#statusModal").find(".userEmail").text(userEmail);

                $("#statusModal").find(".userPhone").text($(this).attr("data-phone"));

                $("#statusModal").find(".productN").text($(this).attr("data-prod"));

                await loadsubscriptionLog(id, ProductId);
                await loadplansforcustomerandproduct(id, ProductId);
            });

            var customerId = '@ViewBag.Customer';
            var productId = '@ViewBag.Product';
            $(".viewSub[data-custid='" + customerId + "'][data-productid='" + productId + "']").click();
            $("#statusModal").find(".MachineKey").val('@ViewBag.MachineKey');

        });
        var body = ``;
        var buttons=``;


               async function GetOrganizations() {
            const result = await AjaxCall("/Home/GetOrganizations");
            let IncludeData = JSON.parse(JSON.parse(JSON.parse(result)));

            if (IncludeData[0]["Error"] == '-202') {
                toastr.error("No Organisations have been registered under any products yet!!!.");
            } else {
                let body = '';
                for (var i = 0; i < IncludeData.length; i++) {
                    let planDetails = ''; // Initialize variable to hold the PlanDetails section

                    // Check if IsVerified == 1 and add PlanDetails to body if true
                    if (IncludeData[i].IsVerified == 1) {
                        planDetails = `
                            <div class="PlanDetails${IncludeData[i].ProductId} border border-danger p-3 container-fluid">
                                <div class="row g-3">
                                    <!-- Info Card -->
                                    <!--  <div class="col-lg-4 col-md-6 col-12">
                                        <div class="card h-100 border border-dark p-3">
                                            <h3 class="text-center border border-dark rounded p-2">Your Info</h3>
                                            <div class="card-body text-center">
                                                <img src="/files/assets/images/employee.png" class="img-fluid mb-3" style="max-width: 80px;" />
                                                <div class="text-start">
                                                    <p class="infotext text-wrap"><strong>Username:</strong> ${IncludeData[i].CompanyName}</p><br>
                                                    <p class="infotext text-wrap"><strong>Email:</strong> ${IncludeData[i].userEmail}</p>
                                                    <p class="infotext text-wrap"><strong>Contact:</strong> ${IncludeData[i].UserContact}</p>
                                                    <p class="infotext text-wrap"><strong>Address:</strong> ${IncludeData[i].Address}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>  -->

                                    <!-- Plan Details Card -->
                                    <div class="col-lg-6 col-md-6 col-12">
                                        <div class="card plan h-100 text-white p-3">
                                            <h2 class="text-center border border-white rounded p-2" style="color:white;">Plan Details</h2>
                                            <div class="card-body text-center">
                                                <div class="d-flex justify-content-center mb-3">
                                                    <div class="circularchart bg-light rounded-circle d-flex align-items-center justify-content-center"
                                                        style="width: 100px; height: 100px;">
                                                        <canvas id="subscriptionChart"></canvas>
                                                    </div>
                                                </div>
                                                <h5 style="color:white;"><span id="RemainingPlan" style="color:white;font-size:28px;font-weight:700;"></span></h5>
                                                <div class="text-start">
                                                    <p class="text-wrap"><i class="fa fa-circle-check text-success"></i> <strong>Product:</strong>${IncludeData[i].ModuleName}</p>
                                                    <p class="text-wrap"><i class="fa fa-circle-check text-success"></i> <strong>Type:</strong> ${IncludeData[i].Type}</p>
                                                    <p class="text-wrap"><i class="fa fa-circle-check text-success"></i> <strong>Current Plan:</strong> <span class="CurrentlySubscription"></span></p>
                                                    <p class="text-wrap"><i class="fa fa-circle-check text-success"></i> <strong>Next Due Date:</strong><span class="CurrentlySubscriptionEndDate"></span></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- School Profile Card -->
                                    <div class="col-lg-6 col-md-12 col-12">
                                        <div class="card h-100 border border-dark p-3">
                                            <h3 class="text-center border border-dark rounded p-2">Organization Profile</h3>
                                            <div class="card-body text-center">
                                                <img src="/files/assets/images/employee.png" class="img-fluid mb-3" style="max-width: 80px;" />
                                                <div class="text-start">
                                                    <p class="infotext text-wrap"><strong>Display Name:</strong> ${IncludeData[i].DisplayName}</p><br>
                                                    <p class="infotext text-wrap"><strong>Address:</strong> ${IncludeData[i].Address}</p><br>
                                                    <p class="infotext text-wrap"><strong>url:</strong> ${IncludeData[i].ReturnURL}</p><br>
                                                    <p class="infotext text-wrap"><strong>Email:</strong> ${IncludeData[i].OrganizationMail}</p><br>
                                                    <p class="infotext text-wrap"><strong>Country:</strong> ${IncludeData[i].OrganizationMotto}</p><br>
                                                    <p class="infotext text-wrap"><strong>Phone:</strong> ${IncludeData[i].PhoneNo}</p><br>
                                                    <p class="infotext text-wrap"><strong>Website:</strong> ${IncludeData[i].Website}</p><br>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    }

                    body += `
                        <div class="OrgCard${IncludeData[i].ProductId} card p-5 m-5" style="border:1px solid black;overflow-y:auto;">
                            <div class="card-header" style="background-color:#E4DBFF;">
                                <div class="SchoolInfo center" style="display: flex; align-items: center;">
                                    <div class="imageinfo" style="flex-shrink: 0; width: 72px; height: 72px; border-radius: 50%;display: flex; justify-content: center; align-items: center; background-color: lightgray;">
                                        <img src="/files/assets/images/employee.png" class="img-fluid" style="max-width: 100px;" />
                                    </div>
                                    <div class="mainInfo" style="margin-left: 20px; text-align: center; flex-grow: 1;">
                                        <p style="font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 24px; line-height: 72px;">${IncludeData[i].CompanyName}</p>
                                        <p style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 18px;">${IncludeData[i].Address}</p>
                                        <span style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 18px;"><a class="UserOrgurl" href="${IncludeData[i].ReturnURL}"></a>${IncludeData[i].ReturnURL}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="buttonsHere">
                                <div class="buttonsDiv p-5" style="text-align:right;float:right;">
                                    ${IncludeData[i].IsVerified == 0 ?
                                        `<button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#updateOrganization" data-OrgId=${IncludeData[i].OrgId} data-token="${IncludeData[i].Token}" id="editBtn" >Edit</button>` : ''}
                                    ${IncludeData[i].IsVerified !== 1 && IncludeData[i].IsVerified !== -1 ?
                                        `<button class="btn btn-xs btn-warning"><i class="fa fa-clock"></i>Pending</button>&nbsp;<button type="button" class="btn btn-sm btn-danger" data-token="${IncludeData[i].Token}" id="deleteBtn"><i class="fas fa-trash"></i></button>` : ''}
                                    ${IncludeData[i].IsVerified == 1 ?
                                        `<button class=" btn btn-success btn-xs"><i class="fa fa-circle-check"></i>Verified</button>
                                         <button class="viewSub btn btn-danger btn-xs" data-bs-toggle="modal" data-bs-target="#statusModal"
                                         data-phone="${IncludeData[i].UserContact}" data-prod="${IncludeData[i].ModuleName}" data-userEmail="${IncludeData[i].userEmail}"
                                         data-productid="${IncludeData[i].ProductId}" data-custid="${IncludeData[i].custId}">
                                         <i class="fa fa-square"></i><i class="fa fa-square"></i> <i class="fa fa-play"></i>Extend</button>` : ''}
                                    ${IncludeData[i].IsVerified == -1 ?
                                        `<button class="viewSub btn btn-success btn-xs"><i class="fa fa-eye-slash"></i>Declined</button> Reason: ${IncludeData[i].Remarks}` : ''}
                                </div>
                            </div>
                            ${planDetails} <!-- Append PlanDetails section if IsVerified == 1 -->
                        </div>
                    `;

                    if (IncludeData[i].OrganizationMotto != 'Nepal') {
                        $(".pyFonepay").hide();
                    }
                }

                $(".mainContent").empty().append(body);
            }
            }
     

         //get the organisation subscription log
        $(document).on('click', '.viewSub', async function () {
            var id = $(this).attr("data-custid");
            var ProductId = $(this).attr("data-productid");
            $("#custid").val(id);
            $("#prodid").val(ProductId);
               var userEmail = $(this).attr("data-useremail");
                $("#statusModal").find(".userEmail").text(userEmail);

                $("#statusModal").find(".userPhone").text($(this).attr("data-phone"));

                $("#statusModal").find(".productN").text($(this).attr("data-prod"));
            await loadsubscriptionLog(id, ProductId);
            await loadplansforcustomerandproduct(id, ProductId)

            if('@ViewBag.MachineKey'==""||'@ViewBag.MachineKey'==null){
                $("#statusModal").find(".MachineKey").val("Online");
                 if($(this).parents(".card").find(".ProductType").text()=="Desktop"){
                       $(".hideme").show();
                     $("#statusModal .ExtendTab").hide();
                     $("#statusModal .LogTab").show().addClass("active");
                     $("#Log").addClass("active").show();
                     $("#Extend").removeClass("active").hide();

                 }else if($(this).parents(".card").find(".ProductType").text()=="Online"){
                     $(".hideme").hide();
                     $("#statusModal .ExtendTab").show();
                     $("#Extend").addClass("active").show();
                     $("#statusModal .LogTab").removeClass("active").show();
                     $("#statusModal .LogTab").show();

                 }
            }

        });
      
        //-----------------subscription log-------------
         async function loadsubscriptionLog(CustomerId, ProductId) {

            var parm = {
                CustomerId: parseInt(CustomerId),
                ProductId: parseInt(ProductId)
            };
            var jsub = await AjaxCall("/CustomerPlanDetails/getSubscriptionLogByCustandprodId", parm);
            var sub = JSON.parse(jsub);
            var jsonData = JSON.parse(sub);

            var subDOM = "";
            if (jsonData.length > 0) {
                for (var i = 0; i < jsonData.length; i++) {
                    // var rawDate=jsonData[i]["ExpireDate"];
                    // var dateParts = rawDate.split(" ");
                    // var formattedDate = `${dateParts[0]} ${dateParts[1]} ${dateParts[2]}`;
                    subDOM += `<tr>
                    <td class="center"><b>`+(i+1)+`</b></td>
                    <td class="center"><button class="btn btn-danger PrintLog" data-ukid="`+jsonData[i]["ukid"]+`"><i class="fas fa-print"></i></button></td>
                    <td class="center">`+ jsonData[i]["fonepayTraceId"] + `</td>
                                            <td class="center">`+ jsonData[i]["productName"] + `</td>
                                            <td class="center">`+ jsonData[i]["SubscriptionPlan"] + `</td>
                                            <td class="center">`+ jsonData[i]["IssuedDate"] + `</td>
                                            <td class="center">`+ jsonData[i]["ExpireDate"] + `</td>
                                            <td class="center">`+ jsonData[i]["Remarks"] + `</td>
                                            <td class="center">`+ jsonData[i]["PaymentRemarks"] + `</td>
                                            <td class="center">`+ jsonData[i]["PaymentMethod"] + `</td>
                                            <td class="center">`+ jsonData[i]["PaymentPartner"] + `</td>
                                            <td class="center">`+ jsonData[i]["PaidAmount"] + `</td>
                                            <td class="center">`+ jsonData[i]["ReferenceId"] + `</td>
                                            <td class="center hideme">`+ jsonData[i]["MachineKey"] + `</td>
                                            <td class="center">`+ jsonData[i]["Licensekey"] + `</td>

                                        `;
                }
                $("#statusModal").find("#cLogTable tbody").empty().append(subDOM);
            } else {
                toastr.error("No Log Found!!!");
                $("#statusModal").find("#cLogTable tbody").empty().append(`<tr><td colspan="9" class="center"><span class="red" style="font-size:24px;">No Log Found !!!</span></td></tr>`);
            }
        }

        async function loadplansforcustomerandproduct(CustomerId, ProductId) {
            debugger
            var parm = {
                CustomerId: parseInt(CustomerId),
                ProductId: parseInt(ProductId)
            };

            var ddd = await AjaxCall("/CustomerPlanDetails/getCurrentPlan", parm);
            var response = JSON.parse(ddd);
            var planData = JSON.parse(response);

            var remainingDays = planData[0].RemainingDays;
            var totalDays = planData[0].TotalDaysofPlan;
            var expiredDays = totalDays - remainingDays;
            var expiryDate = new Date(planData[0].CurrentSubExpiryDate);
            $(".OrgCard" + ProductId).find(".PlanDetails" + ProductId).find("#RemainingPlan").text(remainingDays + ' Days');
            var subscriptionChart = "subscriptionChart";  // The id of the canvas
            var ctx = document.getElementById(subscriptionChart).getContext('2d');

            //Create the chart
            var subscriptionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Remaining Days', 'Expired Days'],
                    datasets: [{
                        data: [remainingDays, expiredDays],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutoutPercentage: 70, // Make the center empty for a donut chart
                    plugins: {
                        tooltip: {
                            callbacks: {
                                // Custom tooltip content
                                label: function (tooltipItem) {
                                    let label = tooltipItem.label;
                                    let value = tooltipItem.raw;
                                    if (label === 'Remaining Days') {
                                        return remainingDays;
                                    } else if (label === 'Expired Days') {
                                        return expiredDays;
                                    }
                                    return label + ': ' + value + '%';
                                }
                            }
                        },
                        legend: {
                            display: false // Optional: Hide legend if not needed
                        }
                    }
                }
            });
             $(".currentPlan").text('----None---');
            $(".currentPlanEdate").text('__//__//____');
            $(".remainingDaysinCPlan").text('0');
            $(".TotalDaysInCurrentPlan").text('0');

            var parm = {
                CustomerId: parseInt(CustomerId),
                ProductId: parseInt(ProductId)
            };
            // Fetch current plan details
            var ddd = await AjaxCall("/CustomerPlanDetails/getCurrentPlan", parm);
            var response = JSON.parse(ddd);
            var responsefr = JSON.parse(response);

            if (responsefr[0]["ErrorMessage"] == -202) {
                toastr.error("You are not subscribed to the subscription Plan yet!!!");

            } else {
                if (responsefr.length > 0) {
                    // If a current plan exists
                    $(".currentPlan").text(responsefr[0]["CurrentlySubscription"]);


                    //  if($("#statusModal").find(".MachineKey").val()=="")
                    //  {
                    // $("#statusModal").find(".MachineKey").val(responsefr[0]["MachineKey"]||"Online");

                    //  }
                    // var dateParts=responsefr[0]["CurrentSubExpiryDate"].split(" ");
                    // const formattedDate = `${dateParts[0]} ${dateParts[1]} ${dateParts[2]}`;
                    $(".currentPlanEdate").text(responsefr[0]["CurrentSubExpiryDate"]);
                    var remainingDays =  parseInt(responsefr[0]["RemainingDays"]);
                    var totalDays = parseInt(responsefr[0]["TotalDaysofPlan"]);
                    $(".remainingDaysinCPlan").text(remainingDays);
                    $(".TotalDaysInCurrentPlan").text(totalDays);



                     // $("#" + chartId).parents(".card").find("#NextDueDate").text(responsefr[0]["CurrentSubExpiryDate"]);
                     // $("#" + chartId).parents(".card").find("#CurrentPlan").text(responsefr[0]["CurrentlySubscription"]);

                     $(".CurrentlySubscription").text(responsefr[0]["CurrentlySubscription"]);
                     $(".CurrentlySubscriptionEndDate").text(responsefr[0]["CurrentSubExpiryDate"]);



                    if (remainingDays < 5) {
                        toastr.error("Remaining days in the current plan are less than 5!");
                        var qrText = `Your plan has ${remainingDays} days remaining!`;
                        // var qrModal5 = $("#QRModal5").find("#generated-qr");

                        // qrModal5.empty();  // Clear any previous QR code
                        // new QRCode(qrModal5[0], {
                        //     text: qrText,
                        //     width: 250,
                        //     height: 250,
                        //     colorDark: "#000000",
                        //     colorLight: "#ffffff",
                        //     correctLevel: QRCode.CorrectLevel.H
                        // });
                        // $("#QRModal5").modal('show');
                        //     $("#statusModal").modal('close');

                    }

                    // Update the circular progress for the specific organization
                    // $("#" + chartId).attr("data-label", `${remainingDays}D`);
                    // var percentage = (remainingDays / totalDays) * 100;
                    // var roundedPercentage = percentage.toFixed(1);
                    // updateCircularProgress(chartId, roundedPercentage, remainingDays);

                } else {
                    // $("#" + chartId).attr("data-label", `0/0`);
                    // resetCircularProgress(chartId);
                }
            }
            // New/existing plan logic
           // var para = await AjaxCall("/Customer/getSubsbyCusandProductId", parm);        ---------------this fetches all the plans ------------dont delete this code---------

           var para=await AjaxCall("/Customer/getSubsbyCusandProductIdAdmin", parm);
           var data = JSON.parse(para);
            var Jsondata = JSON.parse(data);
            if (Jsondata.length > 0) {
                var selectDOM = ``;
                for (var i = 0; i < Jsondata.length; i++) {
                    //if (Jsondata[i]["IsFound"] == "found") {
                        var noOfDays = parseInt(Jsondata[i]["NoOfMonth"]);
                        var today = new Date();
                        var expireDate = new Date(today);
                        expireDate.setDate(today.getDate() + noOfDays + parseInt($(".remainingDaysinCPlan").text())); // Modify expireDate directly
                        var isoExpireDate = expireDate.toISOString().split('T')[0]; // "YYYY-MM-DD"

                        $("#statusModal").find(".expiryDate").val(isoExpireDate);
                        //$("#statusModal").find(".Amount").val(Jsondata[i]["Amount"]);


                        selectDOM += `<option
                                    value="${Jsondata[i]["id"]}"
                                    data-noday=${noOfDays}
                                    data-expiredate=${isoExpireDate}
                                    amount=${Jsondata[i]['Amount']}
                                    data-IsPaidBased=${Jsondata[i]['IsPaidBased']}>${Jsondata[i]['Name']}</option>`;
                   // }
                }
                $("#statusModal").find(".selectedPackages").empty().append(selectDOM);
        //---------------hide the payment divs----------
                var firstOption = $("#statusModal").find(".selectedPackages option:first");
                 if (firstOption.length > 0) {
                     var defaultAmount = firstOption.attr("amount");
                     var defaultExpiryDate = firstOption.attr("data-expiredate");

                     $("#statusModal").find(".Amount").val(defaultAmount);
                     amountFetchedFromServer=parseFloat(defaultAmount);
                     $("#statusModal").find(".expiryDate").val(defaultExpiryDate);

                     if(firstOption.attr("data-IsPaidBased") === "false"){
                         $(".payment-methods").remove();
                         $(".PaymentDiv").attr("hidden",true);
                     }else{

                         $(".payment-methods").show();
                         $(".PaymentDiv").removeAttr("hidden");
                     }
                      // $(".payment-methods").remove();
                      // $(".PaymentDiv").attr("hidden",true);
                 }
            } else {

                toastr.error("No Subscription Setup is done!!!");
            }
        }
         async function getModuleValues() {
            const result = await AjaxCallWithoutData("/Home/GetModuleValues");

            var data = JSON.parse(JSON.parse(JSON.parse(result)));
            var html = "";
            for (var i = 0; i < data.length; i++) {
                html += `<option data-site="${data[i].SiteName}" value="${data[i].UkId}">${data[i].Name}</option>`;
            }
            $(".moduleSelect").html(html);
        }
    $(document).on("click", ".addOrganization", async () => {
        await getModuleValues();
        $("#staticBackdrop").modal("show");
    });
         // get the image and change it to data url for preview
    $(document).ready(function () {
        const $uploadArea = $("#uploadArea");
        const $fileInput = $("#fileInput");

        // Drag-and-drop handlers
        $uploadArea.on("dragover", function (e) {
            e.preventDefault();
            $(this).css({
                backgroundColor: "#e6f7ff",
                borderColor: "#007bff",
            });
        });

        $uploadArea.on("dragleave", function () {
            $(this).css({
                backgroundColor: "#f9f9f9",
                borderColor: "#999",
            });
        });

        $uploadArea.on("drop", async function (e) {
            e.preventDefault();
            $(this).css({
                backgroundColor: "#f9f9f9",
                borderColor: "#999",
            });

            const files = e.originalEvent.dataTransfer.files;

            if (files.length > 0) {
                handleFileUpload(files);
            }
        });

        // File input change handler
        $(document).on("change", "#fileInput",async function (e) {
          e.preventDefault();
            var parameters = {
            CustomerId: parseInt($("#custid").val()),
            ProductId: parseInt($("#prodid").val()),
        };
        var requestVoucherEntry = await AjaxCall("/CustomerPlanDetails/GetVoucherEntryStatus", parameters);
        var jsResponse = JSON.parse(requestVoucherEntry);
        var jsonData = JSON.parse(jsResponse);

        if (jsonData[0]["Status"] === 200) {

            const files = this.files;
            if (files.length > 0) {
                handleFileUpload(files);
            }else{
                toastr.warning("No image selected!!!");
            }
        }else{
              toastr.error("Please wait until your previous vouchers are checked!!!");
              $("#fileInput").attr("data-filename","");
                $uploadArea.find(".uploadedinfo").text("Pending Voucher !!!");
                $("#statusModal").modal('hide');
        }

        });

            // File upload logic (reuses existing functionality)
    async function handleFileUpload(files) {
        $("#upload").attr("checked", true);

            const formData = new FormData();

            for (let i = 0; i < files.length; i++) {
                formData.append("files", files[i]);
            }

            await $.ajax({
                url: "/Register/UploadPhoto1",
                data: formData,
                processData: false,
                contentType: false,
                type: "POST",
                beforeSend: function () {
                    Swal.fire({
                        html: `<div class="loader" id="loader-6">
                                <span></span>
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <div>
                                <p style="color:#fff; font-size:20px;">PLEASE WAIT...</p>
                            </div>`,
                        background: "unset",
                        allowOutsideClick: false,
                        showConfirmButton: false,
                    });
                },
                success: function (data) {
                    console.log(data);
                    const imgName = data;
                    $uploadArea.attr("data-filename", imgName);
                    $uploadArea.find(".uploadedinfo").text("Uploaded !!!");
                    Swal.close();
                },
                error: function (error) {
                    Swal.close();
                    console.error(error);
                    $uploadArea.find(".uploadedinfo").text("Upload Failed !!!");
                },
            });

    }
    });
        //update the organization
        $(document).on("click", "#updateDetails", async (event) => {
            event.preventDefault();

            if ($("#newcompanyName").val() == '' || $("#newdisplayName").val() == '' || $("#newinitial").val() == '' || $("#newvat").val() == '' || $("#newaddress").val() == '' || $("#newphone").val() == '' || $("#newContactNumber").val() == '' || $("#newEmail").val() == '' || $(".moduleSelect").val() == '') {
                toastr.error("Please fill all the fields");
                return false;
            }
            var token = $("#updateDetails").attr("data-token");
            var companyName = $("#newcompanyName").val();
            var displayName = $("#newdisplayName").val();
            var Country = $("#NewCountrySelect option:selected").text();
            var initial = $("#newinitial").val();
            var vat = $("#newvat").val();
            var address = $("#newaddress").val();
            var phone = $("#newphone").val();
            var contact = $("#newContactNumber").val();
            var Email = $("#newEmail").val();
            var Website = $("#newWebsite").val();
            var motto = $("#newmotto").val();
            var module = $(".moduleSelect").val();
            var logo = $(".logoValue").attr("data-name");

            var specialCharPattern = /[^a-zA-Z0-9]/;
            if (specialCharPattern.test(initial)) {
                toastr.error("Special characters or spaces are not allowed in Initial.");
                return false;
            }

            var data = {
                CompanyName: companyName,
                DisplayName: displayName,
                ContactMobile: contact,
                Initial: initial,
                PanVatNo: vat,
                Address: address,
                PhoneNo: phone,
                Module: parseInt(module),
                OrganizationMail: Email,
                Website: Website,
                ImageName: logo,
                ImageType: '',
                ImageData: logo,
                OrganizationMotto: Country,
                Token: token
            };
            var result = await AjaxCall("/Home/UploadOrganizationData", data);
            if (parseInt(result) == 1) {
                $("#staticBackdrop").modal("hide");
                toastr.success("Organization updated Successfully");
                location.reload();
                return false;
            } else {
                toastr.error("Something went wrong");
            }
        });

    $(document).on("click", ".signoutBtn", async () => {
        var result = await AjaxCallWithoutData("/Login/LogOut");
        if (result == "Success") {
            window.location.href = "/Login/Index";
        }
    });
         $(document).on("click", "#submitDetails", async (event) => {
            event.preventDefault(); // Prevent the default form submission behavior

        if ($("#companyName").val() == '') {
        toastr.warning("Please fill in the Company Name");
        return false;
    }

    if ($("#displayName").val() == '') {
        toastr.warning("Please fill in the Display Name");
        return false;
    }

    if ($("#initial").val() == '') {
        toastr.warning("Please fill in the Initial");
        return false;
    }

    if ($("#vat").val() == '') {
        toastr.warning("Please fill in the VAT");
        return false;
    }

    if ($("#address").val() == '') {
        toastr.warning("Please fill in the Address");
        return false;
    }

    if ($("#phone").val() == '') {
        toastr.warning("Please fill in the Phone");
        return false;
    }

    if ($("#ContactNumber").val() == '') {
        toastr.warning("Please fill in the Contact Number");
        return false;
    }

    if ($("#Email").val() == '') {
        toastr.warning("Please fill in the Email");
        return false;
    }

    if ($(".moduleSelect").val() == '') {
        toastr.warning("Please select a Module");
        return false;
    }


            var companyName = $("#companyName").val();
            var displayName = $("#displayName").val();
            var Country = $("#CountrySelect option:selected").text();
            var initial = $("#initial").val();
            var vat = $("#vat").val();
            var address = $("#address").val();
            var phone = $("#phone").val();
            var contact = $("#ContactNumber").val();
            var Email = $("#Email").val();
            var Website = $("#Website").val();
            var logo = $(".logoValue").attr("data-name");
            var module = parseInt($("#staticBackdrop").find("#moduleSelect").val());
           // var module = parseInt($("#staticBackdrop").find("#moduleSelect").val());


            // Check for special characters in the initial
            var specialCharPattern = /[^a-zA-Z0-9]/;
            if (specialCharPattern.test(initial)) {
                toastr.error("Special characters or spaces are not allowed in Initial.");
                return false;
            }

            // if (!logo) {
            //     await uploadLogoAndSubmitForm();
            //     return; // Exit the function after uploading logo asynchronously
            // }

            var checkdata = {
                Initial: initial
            };
            var result1 = await AjaxCall("/Home/CheckInitialName", checkdata);

            var data = {
                CompanyName: companyName,
                DisplayName: displayName,
                ContactMobile: contact,
                Initial: initial,
                PanVatNo: vat,
                Address: address,
                PhoneNo: phone,
                Module: parseInt(module),
                OrganizationMail: Email,
                Website: Website,
                ImageName: '',
                ImageType: '',
                ImageData:'',     // logo,
                OrganizationMotto: Country,
                Token: ""
            };

            if (result1.StatusCode == 201) {
                // Initial exists
                toastr.error("Initial already created. Please change it.");
            }
            else {
                var result = await AjaxCall("/Home/UploadOrganizationData", data);
                if (parseInt(result) === 1) {
                    $("#staticBackdrop").modal("hide");
                    toastr.success("Organization Added Successfully");
                    location.reload();

                } else {
                    toastr.error("Something went wrong");
                }
            }
        });

        async function uploadLogoAndSubmitForm() {
            var imgSrc = $(".logoValue").attr("src");

            var response = await fetch(imgSrc);
            var blob = await response.blob();
            var formData = new FormData();
            formData.append("files", blob, "logo.png");


            var data = await $.ajax({
                url: "/Register/UploadPhoto",
                data: formData,
                processData: false,
                contentType: false,
                type: "POST"
            });


            imgName = data;
            $(".logoValue").attr("data-name", imgName);

        }


        $(document).on("click", ".PrintLog", async function () {

            var parm={
                unqId:parseInt($(this).attr("data-ukid"))
            };
                 var reqestInvoicePrint=await AjaxCall("/Home/getInvoiceForPrint",parm);
                 var responseInvoiceData=JSON.parse(reqestInvoicePrint);
                 var JSONData=JSON.parse(responseInvoiceData);

                 if(JSONData.length>0){
                    var invoiceData = {
                            PaymentStatus:  JSONData[0]["PaymentStatus"],
                             CustomerName: JSONData[0]["CustomerName"] ? JSONData[0]["CustomerName"].toString() : "",
                             CustomerAddress: JSONData[0]["CustomerAddress"] ? JSONData[0]["CustomerAddress"].toString() : "",
                             Product: JSONData[0]["Product"] ? JSONData[0]["Product"].toString() : "",
                             PlanName: JSONData[0]["PlanName"] ? JSONData[0]["PlanName"].toString() : "",
                             Amount: JSONData[0]["Subtotal"] ? JSONData[0]["Subtotal"].toString() : "",
                             TransactionId: JSONData[0]["TransactionId"] ? JSONData[0]["TransactionId"].trim().toString() : "",
                             PaymentGateway: JSONData[0]["PaymentGateway"] ? JSONData[0]["PaymentGateway"].toString() : "",
                             TotalAmount: JSONData[0]["TotalAmount"] ? parseFloat(JSONData[0]["TotalAmount"]).toString() : "0",
                             Vat: JSONData[0]["Vat"] ? parseFloat(JSONData[0]["Vat"]).toString() : "0",
                             Subtotal: JSONData[0]["Subtotal"] ? parseFloat(JSONData[0]["Subtotal"]).toString() : "0",
                             InvoiceDate: JSONData[0]["InvoiceDate"] ? JSONData[0]["InvoiceDate"].toString() : "",
                             DueDate: JSONData[0]["DueDate"] ? JSONData[0]["DueDate"].toString() : "",
                     };
                       var reqInvoice = await AjaxCall("/Home/CreateInvoice", invoiceData);
                       window.open("/Home/InvoicePage", "_blank");

                 }else{
                     toastr.error("No Entry found for the Log");
                 }
        });

        //delete the organization
        $(document).on("click", "#deleteBtn", async function () {
            var token = $(this).attr("data-token");
            Swal.fire({
                title: "Are you sure?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, delete it!",
                cancelButtonText: "No, cancel!",
                reverseButtons: true,
            }).then(async (result) => {
                if (result.isConfirmed) {
                    var result = await AjaxCall("/Home/DeleteSingleOrganization", { Token: token });
                    var parsedResult = JSON.parse(result);
                    //or parsedResult = result.json();
                    if (parsedResult == 1) {
                        toastr.success("Organization Deleted Successfully");
                        location.reload();
                    } else {
                        toastr.error("Something went wrong");
                    }
                }
            })

        });

        $(document).on("change", "#fileInput", async function (e) {
            var filedom = $(this);
            var input = $(this);
            var files = input[0].files;

             e.preventDefault();
            var parameters = {
            CustomerId: parseInt($("#custid").val()),
            ProductId: parseInt($("#prodid").val()),
        };
        var requestVoucherEntry = await AjaxCall("/CustomerPlanDetails/GetVoucherEntryStatus", parameters);
        var jsResponse = JSON.parse(requestVoucherEntry);
        var jsonData = JSON.parse(jsResponse);

        if (jsonData[0]["Status"] === 200) {

            // Check if any file is selected
            if (files.length === 0) {
                alert("Please select a file to upload.");
                return;
            }

            var formData = new FormData();
            for (var i = 0; i < files.length; i++) {
                formData.append("files", files[i]); // Append the file with key 'files'
            }

            await $.ajax({
                url: "/Register/UploadPhoto1", // Your controller endpoint
                data: formData,
                processData: false,    // Don't process the data
                contentType: false,    // Let the browser set the content type
                type: "POST",
                beforeSend: function () {
                    Swal.fire({
                        html: '<div class="loader" id="loader-6">' +
                            '<span></span>' +
                            '<span></span>' +
                            '<span></span>' +
                            '<span></span>' +
                            '</div>' +
                            '<div>' +
                            '<p style="color:#fff; font-size:20px;">PLEASE WAIT...</p>' +
                            '</div>',
                        background: 'unset',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                    });
                },
                success: function (data) {
                    console.log(data);
                    var imgName = data;
                    $(filedom).attr("data-filename", imgName);
                    $(filedom).parents(".gethere").find(".uploadedinfo").text("Uploaded !!!");
                    Swal.close();
                },
                error: function (error) {
                    Swal.close();
                    console.log(error);
                    $(filedom).parents(".gethere").find(".uploadedinfo").text("Upload Failed !!!");
           }
            });
            }
            else{
                toastr.error("Pending Voucher!!!");
            }
        });


           // Payment method change event
         $('input[name="payment"]').change(async function (event) {
                  var $fileUpload = $('#file-upload');
                 var $qrCode = $('#qr-code');
                 var $fileInput = $('#fileInput');
                 var $fileError = $('#fileError');
                 event.preventDefault();
                      if ($(this).attr('id') === 'upload') {
                          $("#upload").attr("checked",true);

                         $fileUpload.show();
                         $qrCode.hide();
                     } else if ($(this).attr('id') === 'fonepay') {
                     if ($(".rem").val() == "") {
                         toastr.error("Please enter a remarks before proceeding to payment!!!");
                     } else {
                      if ($('#fonepay').is(':checked')) {
                     var amount = parseFloat($("#statusModal").find(".Amount").val());


                     // Check if the fetched amount from the frontend matches the server amount
                     if (parseFloat(amountFetchedFromServer) !== amount) {
                         toastr.error("The amount fetched from the server and the amount from the frontend are not equal!!!");
                         return;  // Exit the function if amounts do not match
                     }

                     // Proceed only if the amounts are the same
                     var Product = $("#statusModal").find(".productN").text();
                     var Amount = parseFloat($("#statusModal").find(".Amount").val());
                     var newExpDate = $("#statusModal").find(".selectedPackages :selected").attr("data-expiredate");
                     var PlanName = $("#statusModal").find(".selectedPackages :selected").text();

                         if (amount) {
                         var bankDetails = {
                             amount: parseFloat(amountFetchedFromServer),
                             Purpose: "Live",
                             Remarks1: $("#statusModal").find(".rem").val(),
                             Remarks2: "Insoft Subscription"
                         };

                         // Call the backend to generate QR code and get the PRN
                         var aahaha = await AjaxCall("/QRCodeForPayment/FonePayProceed", bankDetails);
                         var response = JSON.parse(aahaha);
                         $("#statusModal").modal('hide');
                         $("#QRModal").modal('show');

                         // Ensure response contains hashKey and prn
                         if (response && response.prn && response.hashKey) {
                             var prn = response.prn;
                             $("#QRModal").find("#AmountQr").text(amount);

                             var hashKey = response.hashKey;
                             var qrMessage = response.qrMessage;

                             // Clear any existing QR code before generating a new one
                             $("#generated-qr").empty();

                             // Generate the QR code
                             new QRCode($("#QRModal").find("#generated-qr")[0], {
                                 text: qrMessage,
                                 width: 250,
                                 height: 250,
                                 colorDark: "#000000",
                                 colorLight: "#ffffff",
                                 correctLevel: QRCode.CorrectLevel.H
                             });

                                 var $qrCode = $("#QRModal").find("#generated-qr-container");
                                  $qrCode.show();

                             // Flag to check if payment has been successfully processed
                             var paymentSuccessHandled = false;

                             // Start checking payment status every 2 seconds for this specific transaction (by prn)
                             var paymentStatusInterval = setInterval(async function () {
                                 var getQRresponse = await AjaxCallNoAsync("/QRCodeForPayment/GetPaymentStatus", { qrHashKey: hashKey, prn: prn });
                                 var paymentResponse = JSON.parse(getQRresponse);

                                 if (paymentResponse[0]["paymentStatus"] === 'success' && !paymentSuccessHandled) {
                                     paymentSuccessHandled = true;

                                     // Handle successful payment, update database, send SMS/email, etc.
                                     var parm = {
                                         SubscriptionType: parseInt($("#statusModal").find(".selectedPackages :selected").val()),
                                         ExpiryDate: newExpDate,
                                         PaidAmount: parseFloat(paymentResponse[0]["totalTransactionAmount"]),
                                         Remarks: $("#statusModal").find(".rem").val(),
                                         CustomerId: parseInt($("#custid").val()),
                                         ProductId: parseInt($("#prodid").val()),
                                         TransactionId: 0,
                                         PaymentMethod: 'QR',
                                         ReferenceId: 0,
                                         PaymentPartner: 'FonePay',
                                         GeneratedSerialNo: 'sn001',
                                         VoucherImage: null,
                                         fonepayTraceId: parseInt(paymentResponse[0]["fonepayTraceId"]),
                                         IsVerifiedPayment: 1,
                                         Machinekey:$("#statusModal").find(".MachineKey").val()||"Online"
                                     };

                             var cpp = await AjaxCall("/CustomerPlanDetails/InsertUpdate", parm);

                             if (cpp != 'Success') {
                                 toastr.error("Server side problem in extending the Plan");
                             } else {

                                 try {
                                                      var invoiceData = {
                                                                   InvoiceDate: new Date().toLocaleDateString(),
                                                                   DueDate: new Date(newExpDate).toLocaleDateString(),
                                                                   CustomerName: $("#statusModal").find(".userPhone").text() || "",
                                                                   CustomerAddress: "Pokhara, Simalachaur, Pokhara, Mid Western, 44204, Nepal",
                                                                   Product: Product.toString(),
                                                                   PlanName: PlanName.toString(),
                                                                   Amount: paymentResponse[0]["totalTransactionAmount"].toString(),    /// changed from Amount to paymentResponse[0]["totalTransactionAmount"].toString() after hosting , needs to be tested
                                                                   TransactionId: paymentResponse[0]["fonepayTraceId"].toString(),
                                                                   PaymentGateway: "FonePay",
                                                                   TotalAmount: paymentResponse[0]["totalTransactionAmount"].toString(),
                                                                   Vat: (paymentResponse[0]["totalTransactionAmount"] * 0.13).toFixed(2),
                                                                   Subtotal: (paymentResponse[0]["totalTransactionAmount"] - (paymentResponse[0]["totalTransactionAmount"] * 0.13)).toFixed(2)
                                                               };
                                             var reqInvoice1 = await AjaxCall("/Home/CreateInvoice", invoiceData);
                                             var haha=JSON.parse(reqInvoice1);

                                           if (haha.success) {
                                            window.location.href = "/Home/InvoicePage";
                                            //    window.open("/Home/InvoicePage", "_blank");   window.open("/Home/InvoicePage", "_blank");
                                           }

                                     toastr.success("Subscription Extension Successful!!!");
                                     $("#statusModal").find(".rem").val('');
                                     $("#QRModal").modal('hide');
                                 } catch (error) {
                                     toastr.error("An error occurred while generating the invoice.");
                                 }



                                     // Send success SMS to the user
                                     var parm = {
                                         SMS_Message: `Your subscription of ${Product} has been extended with a ${PlanName} Plan of Rs.${Amount}.The next due date is on ${newExpDate}. Thank you for choosing Insoft R & D.`,
                                         MobileNo: $("#statusModal").find(".userPhone").text()
                                     };

                                     var successmsg = await AjaxCall("/Dashboard/SendSMS", parm);

                                     // Send confirmation email to the user
                                         const codeBody = `<div style="margin: 0; padding: 0; background-color: #f8f9fa;">
                                                 <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 36px 20px; font-family: Arial, sans-serif; color: #333;">
                                                     <div style="text-align: center;">
                                                         <img src="https://incloud.academeplus.com/fileuploads/Subscription/703445501703445501-1543-LogoInsoft.png" alt="Insoft" style="max-width: 100%; height: auto;">
                                                     </div>
                                                     <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #000;">Subscription Extension Confirmation</h2>
                                                     <p style="font-size: 16px; font-weight: 400; margin-bottom: 20px;">Dear Valued Customer,</p>
                                                     <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                         We are pleased to inform you that your subscription to the <strong>${Product}</strong> product has been successfully extended.
                                                         Below are the details of your extended subscription:
                                                     </p>
                                                     <table style="width: 100%; border: 1px solid #ddd; border-collapse: collapse; margin-bottom: 20px;">
                                                         <tr style="background-color: #f4f4f4; text-align: left;">
                                                             <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Subscription Plan</th>
                                                             <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Amount Paid</th>
                                                             <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Next Due Date</th>
                                                         </tr>
                                                         <tr>
                                                             <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${PlanName}</td>
                                                             <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${Amount}</td>
                                                             <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${newExpDate}</td>
                                                         </tr>
                                                     </table>
                                                     <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                         The next due date of your subscription is <strong>${newExpDate}</strong>.
                                                         If you have any questions or require further assistance, feel free to contact us at 061-543815.
                                                     </p>
                                                     <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                         Thank you for choosing us. We appreciate your continued trust and look forward to serving you.
                                                     </p>
                                                     <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                         Best regards, <br>
                                                         Insoft Research & Development
                                                     </p>
                                                 </div>
                                             </div>`;
                                     const toUser = {
                                         ReceiverEmail: $("#statusModal").find(".userEmail").text(),
                                         Subject: "Subscription Extended",
                                         EmailBody: codeBody,
                                     };

                                     var successEmail = await AjaxCall("/Dashboard/SendEmail", toUser);

                                     // Send email to Insoft team
                                         const insoftEmailBody = `<div style="margin: 0; padding: 0; background-color: #f8f9fa;">
                                                 <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 36px 20px; font-family: Arial, sans-serif; color: #333;">
                                                     <div style="text-align: center;">
                                                         <img src="https://incloud.academeplus.com/fileuploads/Subscription/703445501703445501-1543-LogoInsoft.png" alt="Insoft" style="max-width: 100%; height: auto;">
                                                     </div>
                                                     <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #000;">Payment Successful - Subscription Extension</h2>
                                                     <p style="font-size: 16px; font-weight: 400; margin-bottom: 20px;">Dear Team,</p>
                                                     <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                         The subscription of the <strong>${Product}</strong> product has been successfully extended by the Customer themselves through the FonePay QR provided in our Software..
                                                         Below are the details of the transaction:
                                                     </p>
                                                     <table style="width: 100%; border: 1px solid #ddd; border-collapse: collapse; margin-bottom: 20px;">
                                                         <tr style="background-color: #f4f4f4; text-align: left;">
                                                             <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Subscription Plan</th>
                                                             <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Amount Paid</th>
                                                             <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Expiry Date</th>
                                                         </tr>
                                                         <tr>
                                                             <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${PlanName}</td>
                                                             <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${Amount}</td>
                                                             <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${newExpDate}</td>
                                                         </tr>
                                                     </table>
                                                     <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                         The customer is now subscribed to the new plan until <strong>${newExpDate}</strong>.
                                                     </p>
                                                     <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                         Best regards, <br>
                                                         Insoft Research & Development
                                                     </p>
                                                 </div>
                                             </div>`;
                                     const toInsoft = {
                                         ReceiverEmail: "insoftrnd@gmail.com",
                                         Subject: "Payment Successful - Subscription Extension",
                                         EmailBody: insoftEmailBody,
                                     };

                                     var insoftEmail = await AjaxCall("/Dashboard/SendEmail", toInsoft);
                                     await GetOrganizations();
                                         }




                                     }
                             }, 2000); // Poll every 2 seconds

                            // Stop payment status polling when modal is closed or loses focus
                             $('#QRModal').on('hidden.bs.modal', function () {

                                 clearInterval(paymentStatusInterval);
                                 $("#statusModal").find(".rem").val('');
                                 $("#statusModal").find("#upload").attr("checked", false);
                                 $("#generated-qr-container").find("#generated-qr").empty();
                             });

                         }
                         else {
                             $qrCode.hide();

                             toastr.error(""+response.message+"");
                         }
                     } else {
                         $qrCode.hide();
                     }
                 } else {
                     // Handle other cases if needed
                 }
             }
         }
     });

         $(document).on('change', '.selectedPackages', function () {

                if ($(".selectedPackages :selected").attr("data-IsPaidBased") === "false") {
                     $(".payment-methods").remove();
                     $(".PaymentDiv").attr("hidden", true);
                 } else {
                          $(".payment-methods").show();
                          $(".PaymentDiv").removeAttr("hidden");
                 }


         var CurrentExpirydate = $("#statusModal").find(".currentPlanEdate").text();
         var noOfDays = parseInt($(".selectedPackages option:selected").attr("data-noday"), 10);
         amountFetchedFromServer = $(".selectedPackages option:selected").attr("amount");

         if (CurrentExpirydate && !isNaN(noOfDays)) {
             // Convert to a valid date format
             var parsedJoinDate = new Date(CurrentExpirydate.replace(/\s+/g, ' ').replace('PM', ' PM').replace('AM', ' AM'));
             if (!isNaN(parsedJoinDate.getTime())) {
                 parsedJoinDate.setDate(parsedJoinDate.getDate() + noOfDays);
                 var expiryDate = parsedJoinDate.toISOString().split('T')[0];

                 $(this).parents("#statusModal").find(".expiryDate").val(expiryDate);
                 $(this).parents("#statusModal").find(".Amount").val($(".selectedPackages option:selected").attr("amount"));
             } else {
                 console.error("Invalid join date format");
             }
         } else {
             toastr.error("Invalid join date or number of days");
         }
     });

    $(".payment-option").on("click",function(){

       if($("#statusModal .rem").val() == "")
       {
             $("#upload").prop("checked", false);
             $("#fonepay").prop("checked", false);
             $("#fileInput").val("");
         toastr.warning("Please Fill Remarks First !!!");
       }
    });

       $(document).on('click', '#statusModal .btnExtendPlan', async function (e) {
         e.preventDefault();
           var PaymentType=$('input[name="payment"]:checked').val();

           if(PaymentType==undefined){
           toastr.warning("Please Select Payment Method!!!");
           }
           else if($("#statusModal .rem").val() == ""){
           toastr.warning("Please Fill Remarks First !!!");
           }
           else if(PaymentType=="fonepay")
           {
               var parm = {
                     SubscriptionType: parseInt($("#statusModal").find(".selectedPackages :selected").val()),
                     ExpiryDate: $("#statusModal").find(".selectedPackages :selected").attr("data-expiredate"),
                     PaidAmount: parseFloat($("#statusModal").find(".Amount").val()),
                     Remarks: $("#statusModal").find(".rem").val(),
                     CustomerId: parseInt($("#custid").val()),
                     ProductId: parseInt($("#prodid").val()),
                     TransactionId: 0,
                     PaymentMethod: 'cash',
                     ReferenceId: 0,
                     PaymentPartner: 'none',
                     GeneratedSerialNo: 'sn001',
                     VoucherImage:  null,
                     IsVerifiedPayment: 0,
                     Machinekey:$("#statusModal").find(".MachineKey").val()||"Online"
                 }
                 var cpp = await AjaxCall("/CustomerPlanDetails/InsertUpdate", parm);
                 if (cpp!='Success') {
                     $("#upload").prop("checked",false);
                     $("#fonepay").prop("checked", false);
                     $("#fileInput").val("");

                       toastr.error("Plan extension not successful");
                 }
                 else {
                     $("#upload").prop("checked",false);
                     $("#fonepay").prop("checked", false);
                     $("#fileInput").val("");


                     toastr.success("Plan extension successful");
                       $("#statusModal").modal('hide');
                      $(".rem").val('');
                      GetOrganizations();
                 }
           }
            else if(PaymentType=="file")
            {
               if($("#fileInput").val()==""){
                toastr.warning("Please Select Image First !!!");
                // $(".btnExtendPlan").attr("disabled",true);
                return;
               }
               else
               {
                 var parm = {
                     SubscriptionType: parseInt($("#statusModal").find(".selectedPackages :selected").val()),
                     ExpiryDate: $("#statusModal").find(".selectedPackages :selected").attr("data-expiredate"),
                     PaidAmount: parseFloat($("#statusModal").find(".Amount").val()),
                     Remarks: $("#statusModal").find(".rem").val(),
                     CustomerId: parseInt($("#custid").val()),
                     ProductId: parseInt($("#prodid").val()),
                     TransactionId: 0,
                     PaymentMethod: 'cash',
                     ReferenceId: 0,
                     PaymentPartner: 'none',
                     GeneratedSerialNo: 'sn001',
                     VoucherImage:  $("#fileInput").attr("data-filename"),
                     IsVerifiedPayment: 0,
                     Machinekey:$("#statusModal").find(".MachineKey").val()||"Online"
                 }

                 var cpp = await AjaxCall("/CustomerPlanDetails/InsertUpdate", parm);
                 if (cpp!='Success') {
                     $("#upload").prop("checked",false);
                     $("#fonepay").prop("checked", false);
                     $("#fileInput").val("");

                     toastr.error("Plan extension  not successful");
                 }
                 else {
                      toastr.success("Plan extension successful");
                     await GetOrganizations();
                     $("#statusModal").modal('hide');
                     $("#upload").prop("checked",false);
                     $("#fonepay").prop("checked", false);
                     $("#fileInput").val("");

                 }
              }
           }

         });

     $('#QRModal').on('hidden.bs.modal', function () {
         $("#fileInput").val("");
         $("#fileInput").attr("data-filename","");
         $("#uploadArea").find(".uploadedinfo").text("");
         $("#upload").prop("checked", false);
         $("#fonepay").prop("checked", false);
      });

     $('#statusModal').on('hidden.bs.modal', function () {
         $("#fileInput").val("");
         $("#upload").prop("checked", false);
         $("#fonepay").prop("checked", false);
     });
       
    </script>
