@{
    ViewData["Title"] = "CustomerSubscription";
    Layout = "~/Views/Shared/_MasterLayout.cshtml";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<!-- QR Code Library -->
<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

<style>
    .cardProceed {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
     
        margin: auto;
    }

    .row {
        margin-bottom: 15px;
    }

    label {
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
    }

</style>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

<div class="pcoded-content">
    <div class="page-header-breadcrumb" style="margin-left: 10px;">
        <ul class="breadcrumb-title">
            <li class="breadcrumb-item" style="float: left;">
                <a href="#!"><i class="feather icon-home"></i></a>
            </li>
            <li class="breadcrumb-item" style="float: left;">
                <a href="#!">Sub-Products</a>
            </li>
            <li class="breadcrumb-item" style="float: left;">
                <a href="#!">Modules List</a>
            </li>
        </ul>
    </div>

    <div class="pcoded-inner-content">
        <div class="main-body">
            <div class="page-wrapper">
                <div class="page-body">
                    <div class="row m-t-10 m-l-0 " style="border:1px solid black; background-color:white; border-radius:12px; padding:10px;">
                     
                        <!-- Products Dropdown -->
                        <div class=" col-sm-6 col-md-4" style="padding-right: 5px;">
                            <label>Products</label>
                            <select class="Products form-control">
                                <option class="default" value="0">----All----</option>
                            </select>
                        </div>

                        <!-- Show Button -->
                        <div class=" col-sm-6 col-md-2" style="padding-left: 5px;">
                            <label>&nbsp;</label>
                            <button class="btn btn-insoft btn-sm" type="button" id="showButton">
                                <i class="feather icon-search"></i> Show
                            </button>
                        </div>
                       
                    </div>

                    <!-- Modal for QR -->
                    <div class="modal fade" id="QRModal" style="vertical-align:middle;" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl" style="width:90%;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">
                                        Scan the QR below to proceed to payment
                                    </h1>
                                    <button type="button" class="btn btn-close btn-danger" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Using Bootstrap grid classes to make the image responsive -->
                                    <div class="row justify-content-center mb-4">
                                        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                                            <div class="btn btn-sm w-100">
                                                <img src="~/files/assets/images/fonepay-payment-service-limited43.png" class="img-fluid" alt="Fonepay Image" />
                                            </div>
                                        </div>
                                    </div>

                                    <!-- QR code section -->
                                    <div id="generated-qr-container" class="d-flex justify-content-center">
                                        <!-- QR Code will be dynamically inserted here -->
                                        <div id="generated-qr"></div>
                                    </div>

                                    <h1 class="text-center modal-title fs-5" id="hehe">
                                        <br /> INSOFT RESEARCH AND DEVELOPMENT<br /> an amount of <span id="AmountQr"></span>
                                    </h1>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal for customer status -->
                    <div class="modal fade" id="ExtendModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl" style="width:100%; max-width:1500px;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">
                                        Status of<b> <span class="userEmail"></span></b>&nbsp;'s subscription for <b><span class="productN"></span></b>  <br />
                                    </h1>

                                    <button type="button" class="btn-close  btn-danger" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">

                                    <div class="tabbable">

                                        <ul class="nav nav-tabs md-tabs padding-12" id="myTab4" role="tablist">
                                            <li class="nav-item ">
                                                <a class="nav-link active ExtendTab " data-bs-toggle="tab" href="#Extend" role="tab" aria-expanded="false" style=" border-radius:12px 12px 0px 0px; border:1px solid black;">Extend </a>
                                            </li>
                                            <li class=" nav-item ">
                                                <a class="nav-link LogTab" data-bs-toggle="tab" href="#Log" role="tab" aria-expanded="true" style=" border-radius:12px 12px 0px 0px; border:1px solid black;">Subscription Log</a>
                                            </li>
                                        </ul>

                                        <div class="tab-content" style="margin-top:20px;">
                                            <!-- Subscription Details Tab -->
                                            <div id="Log" class="tab-pane table-responsive">
                                                <table id="cLogTableExtend" class="table-fixed table DGV table-striped table-bordered table-hover tblclear" style="width: 100%; border-collapse: separate; padding: 0px;">
                                                    <thead>
                                                        <tr style="background-color: #0b3b56; color: white;">
                                                            <th>S.N.</th>
                                                            <th class="center">Print</th>
                                                            <th>FonePay Trace Id</th>
                                                            <th class="center">Product Name</th>
                                                            <th class="center">Subscription Type</th>
                                                            <th class="center">Issued date</th>
                                                            <th class="center">Next Due Date</th>
                                                            <th class="center">Remarks</th>
                                                            <th class="center">Payment Remarks</th>
                                                            <th class="center">Payment Method</th>
                                                            <th class="center">Payment Partner</th>
                                                            <th class="center">Amount</th>
                                                            <th class="center">Reference Id</th>
                                                            <th class="center hideme">Machine Key</th>
                                                            <th class="center">License Key</th>


                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Add your data rows here -->
                                                    </tbody>
                                                </table>
                                            </div>

                                            <!-- Extend the Plan Tab -->
                                            <div id="Extend" class="tab-pane active" style="padding: 20px; background-color: #f4f7fc; border-radius: 8px;">
                                                <div class="cardWrapper" style="display: flex; justify-content: space-between; gap: 20px; padding: 20px;">

                                                    <!-- Left Side Panel -->
                                                    <div class="d-none d-sm-block leftSide" style="width: 25%; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                                                        <p style="font-size: 14px; color: #333; line-height: 1.6;">
                                                            <strong>Note:</strong><br>
                                                            The payment from Bank Deposit takes up to three days from our side to verify your subscription. Please have patience and enjoy your journey with us!
                                                        </p>
                                                    </div>

                                                    <!-- Main Card Section -->
                                                    <div class="cardProceed col-12 col-sm-6" style="padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                                                        <form>
                                                            <div class="row" style="margin-bottom: 15px;">
                                                                <label style="font-size: 16px; font-weight: bold; color: #333;">Current Plan: <span class="currentPlan" style="color: #888;">None</span></label>
                                                                <label style="font-size: 16px; font-weight: bold; color: #333;">Due Date: <span class="currentPlanEdate" style="color: red;">__/__/____</span></label>
                                                                <label style="font-size: 16px; font-weight: bold; color: #333;" hidden>Remaining Plan (No. of Days):&nbsp;&nbsp;&nbsp;<span class="remainingDaysinCPlan red" style="color: red;"></span> Days out of <span class="TotalDaysInCurrentPlan red" style="color: red;">30</span> Days</label>
                                                            </div>
                                                            <div class="row DivMachine" style="margin-bottom: 15px;">
                                                                <label style="font-size: 16px; font-weight: bold; color: #333;">Machine Key:</label>
                                                                <input type="text" class="form-control MachineKey" disabled required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                                                            </div>

                                                            <div class="row" style="margin-bottom: 15px;">
                                                                <label style="font-size: 16px; font-weight: bold; color: #333;">Select a Package:</label>
                                                                <select class="selectedPackages" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                                                                </select>
                                                            </div>

                                                            <div class="row" style="margin-bottom: 15px;">
                                                                <label style="font-size: 16px; font-weight: bold; color: #333;">Next Due Date:</label>
                                                                <input type="date" class="form-control expiryDate" disabled style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                                                            </div>

                                                            <div class="row" style="margin-bottom: 15px;">
                                                                <label style="font-size: 16px; font-weight: bold; color: #333;">Amount:</label>
                                                                <input type="text" class="form-control Amount" disabled required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                                                            </div>

                                                            <div class="row" style="margin-bottom: 15px;">
                                                                <label style="font-size: 16px; font-weight: bold; color: #333;">Remarks:</label>
                                                                <input type="text" class="form-control rem" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;" />
                                                                <input type="text" id="custid" hidden />
                                                                <input type="text" id="prodid" hidden />
                                                            </div>

                                                            @*  <div class="row" style="margin-bottom: 15px;">
                                            <label style="font-size: 16px; font-weight: bold; color: #333;">Payment Method:</label>
                                            <div class="payment-methods" style="display: flex; gap: 20px;">
                                                <div class="payment-option" data-value="0" style="border:1px solid black;">
                                                    <input type="radio" name="payment" id="upload" />
                                                    <label for="upload" style="font-size: 14px; color: #333; display: flex; align-items: center;">
                                                        Bank Deposit <img src="~/files/assets/images/upload.svg" alt="Upload" style="width: 20px; margin-left: 5px;" />
                                                    </label>
                                                </div>
                                                <div class="payment-option" data-value="3" style="vertical-align: middle; border:1px solid black;">
                                                    <input type="radio" name="payment" id="fonepay" />
                                                    <label for="fonepay" style="font-size: 14px; color: #333; display: flex; align-items: center;">
                                                        <img src="~/files/assets/images/fonepay-payment-service-limited43.png" alt="Fonepay" style="width: 30px; margin-top: 20px;" />
                                                        FonePay
                                                    </label>
                                                </div>
                                            </div>
                                        </div> *@


                                                            <div class="row mb-3">
                                                                <label class="col-12" style="font-size: 16px; font-weight: bold; color: #333;">Payment Method:</label>
                                                                <div class="payment-methods d-flex flex-wrap justify-content-center gap-3 col-12">
                                                                    <!-- Bank Deposit with Drag-and-Drop Upload -->
                                                                    <div class="payment-option col-lg-4 col-md-6 col-sm-12 p-3" data-value="0" style="border: 1px solid black; text-align: center;">
                                                                        <input type="radio" class="form-control d-none" name="payment" id="upload" />
                                                                        <label for="upload" class="w-100" style="font-size: 14px; color: #333; display: block; margin-bottom: 10px;">
                                                                            Bank Deposit
                                                                        </label>
                                                                        <div id="uploadArea" class="gethere" style="border: 2px dashed #999; padding: 20px; position: relative; background-color: #f9f9f9; cursor: pointer;">
                                                                            <p style="font-size: 14px; color: #666;">Drag & Drop or <span style="color: #007bff; text-decoration: underline;">browse files</span></p>
                                                                            <span class="uploadedinfo" style="color: green; font-weight: bold;"></span>
                                                                            <input type="file" class="form-control" id="fileInput" accept="image/*" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;" />
                                                                        </div>
                                                                    </div>

                                                                    <!-- FonePay Option -->
                                                                    <div class="payment-option col-lg-4 col-md-6 col-sm-12 p-3" data-value="3" style="border: 1px solid black; text-align: center;">
                                                                        <input type="radio" class="form-control d-none" name="payment" id="fonepay" />
                                                                        <label for="fonepay" class="w-100" style="font-size: 14px; color: #333; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                                            <img src="~/files/assets/images/fonepay_payments_fatafat.png" alt="Fonepay" style="width: 180px; height: 100px; vertical-align:middle;" />
                                                                            <span>FonePay</span>
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="row" id="file-upload" style="display:none; margin-bottom: 15px;">
                                                              
                                                                <p id="fileError" style="color:red; display:none;"></p>
                                                            </div>

                                                            <div class="row center" id="qr-code" style="display:none; margin-bottom: 15px;">
                                                                <div id="generated-qr" style="text-align:center;"></div>
                                                            </div>

                                                            <div class="row">
                                                                <button class="btn btn-sm btn-success btnExtendPlan" style="width: 100%; padding: 12px; font-size: 16px; border-radius: 4px; border: none; background-color: #28a745; color: white; cursor: pointer;">
                                                                    Proceed &nbsp;<i class="feather icon-save"></i>
                                                                </button>
                                                            </div>
                                                        </form>
                                                    </div>

                                                    <!-- Right Side Panel -->
                                                    <div class="d-none d-sm-block rightSide" style="width: 25%; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                                                        <p style="font-size: 14px; color: #333; line-height: 1.6;">
                                                            <strong>Note:</strong><br>
                                                            Your subscription to the respective Product will be updated as soon as we receive your payment made through FonePay QR.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>

                  

                    <!-- Modal for customer status -->
                    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl" style="width:90%;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">
                                        Status of <b><span class="Customerr"></span></b>'s' Subscription of <b><span class="selectedProduct"></span></b>
                                        <span class="userEmail" hidden></span>
                                        <span class="userPhone" hidden></span>
                                    </h1>
                                    <button type="button" class="btn-close btn-danger" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="TableDiv table-responsive" style="width: 100%; overflow-x: scroll; overflow-y: scroll; position: relative;">
                                    <table id="cLogTable" class="table-fixed table DGV table-striped table-bordered table-hover tblclear" style="width: 100%; border-collapse: separate; padding: 0px;">
                                        <thead>customer's log  
                                            <tr style="background-color: #0b3b56; color: white;">
                                                <th class="center">S.N.</th>
                                                <th class="center">Product Name</th>
                                                <th class="center">Subscription Type</th>
                                                    <th class="center">Amount</th>
                                                <th class="center">Issued date</th>
                                             @*    <th class="center">Last Renewal date</th> *@
                                                <th class="center">Expiry date</th>
                                                <th class="center">Machine Key</th>
                                                <th class="center">Remarks</th>
                                                <th class="center">Payment Method</th>
                                                <th class="center">Payment Partner </th>
                                                
                                                <th class="center">License Key</th>
@*                                                 <th class="center">ExtendedBy</th>
 *@                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                    </div>

                                    <div class="cardProceed" style="max-width:400px;">
                                        <form>
                                            <div class="row">
                                                <label>Current Plan: <span class="currentPlan">None</span></label>
                                                <label>Expiry Date : <span class="currentPlanEdate">__/__/____</span></label>
                                                <label>Remaining Plan (No. of Days):&nbsp;&nbsp;&nbsp;<span class="remainingDaysinCPlan red">1</span> Days <span class="TotalDaysInCurrentPlan red" hidden>30</span> </label>
                                            </div>
                                           
                                            <div class="row">
                                                <label>Select a Package:</label>
                                                <select class="selectedPackages">
                                                   
                                                </select>
                                            </div>
                                            <div class="row">
                                                <label>Expiry Date:</label>
                                                <input type="date" class="expiryDate form-control" disabled/>
                                            </div>
                                           
                                            <div class="row">
                                                <label>Amount:</label>
                                                <input type="text" class="Amount form-control" required disabled />
                                            </div>
                                            <div class="row DivMachine">
                                                <label>Machine Key:</label>
                                                <input type="text" class="MachineKey form-control" required  />
                                            </div>

                                            <div class="row">
                                                <label>Remarks:</label>
                                                <input type="text" class="rem form-control" required />
                                                <input type="text" id="custid"  hidden/>
                                                <input type="text"  id="prodid" hidden/>
                                            </div>
                                            <div class="row">
                                                <button class="btn btn-sm btn-success btnExtendPlan">Proceed &nbsp;<i class="feather icon-save"></i></button>
                                            </div>
                                        </form>
                                    </div>
                               </div>
                                </div>
                            </div>
                        </div>
                    </div>
                 
                    <!-- Modal for Subscription -->
                    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">
                                        <br /><input type="number" id="custid"  hidden/>
                                        <br /><input type="number" id="prodid" hidden />
                                        Choose A Subscription Package for <b>"<span class="Customerr"></span>"</b> for the modules in <b><span class="selectedProduct"></span></b>
                                    </h1>
                                    <button type="button" class="btn-close btn-danger" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <table id="modalTable" class="table-fixed table DGV table-striped table-bordered table-hover tblclear">
                                        <thead>
                                            <tr style="background-color: #0b3b56; color: white;">
                                                <th class="center"></th>
                                                <th class="center">Subscription Package</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-success btn-saveSubs" data-uniqid="0">Save&nbsp;<i class="feather icon-save"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                <div class="ss" style="max-width:120em;">
                    <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 10px;">
                        <!-- Buttons -->
                        <div class="button-group">
                            <button onclick="exportToCSV()" class="rounded btn-xs btn-primary">
                                <i class="feather icon-file-text"></i> CSV
                            </button>
                            <button onclick="copyTable()" class="rounded btn-xs btn-warning">
                                <i class="feather icon-copy"></i> Copy
                            </button>
                            <button onclick="exportToExcel()" class=" rounded btn-xs btn-success">
                                <i class="fa fa-regular fa-file-excel"></i> Excel
                            </button>
                            <button onclick="exportToPDF()" class="rounded btn-xs btn-danger">
                                <i class="feather icon-file-pdf"></i> PDF
                            </button>
                            <button onclick="printTable()" class="rounded btn-xs btn-info">
                                <i class="feather icon-print"></i> Print
                            </button>
                        </div>

                        <!-- Search Bar -->
                        <div class="search-container">
                            <div class="input-group">
                                <input type="text" class="hideme search form-control border-2" placeholder="Search for..." aria-label="Search">
                            </div>
                        </div>
                    </div>
                </div>


                    <div class="TableDiv table-responsive" style="width: 100%; overflow-x: scroll; overflow-y: scroll; height: 70dvh; position: relative;">
                            <table id="agentTable" class=" agentTable table-fixed table DGV table-striped table-bordered table-hover tblclear" style="width: 100%; border-collapse: separate; padding: 0px;">
                                <thead>
                                    <tr style="background-color: #0b3b56; color: white;">
                                        <th class="center">S.N</th>
                                    <th class="center hideme">Subscription</th>
                                        <th class="center">Customer Code</th>
                                        <th class="center">Customer Name</th>
                                        <th class="center"> initial</th>
                                        <th class="center">Product</th>
                                        <th class="center">Address</th>
                                        <th class="center">PAN/VAT Number</th>
                                        <th class="center">Contact Number</th>
                                        
                                    </tr>
                                </thead>
                                
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="text/javascript">
    $(document).ready(function () {
        getProducts();
        updateAmountAndExpiry();
        
    });
        $(document).ready(function () {
        const $uploadArea = $("#uploadArea");
        const $fileInput = $("#fileInput");

        // Drag-and-drop handlers
        $uploadArea.on("dragover", function (e) {
            e.preventDefault();
            $(this).css({
                backgroundColor: "#e6f7ff",
                borderColor: "#007bff",
            });
        });

        $uploadArea.on("dragleave", function () {
            $(this).css({
                backgroundColor: "#f9f9f9",
                borderColor: "#999",
            });
        });

        $uploadArea.on("drop", async function (e) {
            e.preventDefault();
            $(this).css({
                backgroundColor: "#f9f9f9",
                borderColor: "#999",
            });

            const files = e.originalEvent.dataTransfer.files;

            if (files.length > 0) {
                handleFileUpload(files);
            }
        });

         $(document).on("change", "#ExtendModal #fileInput",async function (e) {
          e.preventDefault();
            var parameters = {
            CustomerId: parseInt($("#custid").val()),
            ProductId: parseInt($("#prodid").val()),
        };
        var requestVoucherEntry = await AjaxCall("/CustomerPlanDetails/GetVoucherEntryStatus", parameters);
        var jsResponse = JSON.parse(requestVoucherEntry);
        var jsonData = JSON.parse(jsResponse);

        if (jsonData[0]["Status"] === 200) {

            const files = this.files;
            if (files.length > 0) {
                handleFileUpload(files);
            }else{
                toastr.warning("No image selected!!!");
            }
        }else{
              toastr.error("Please wait until your previous vouchers are checked!!!");
              $("#fileInput").attr("data-filename","");
                $uploadArea.find(".uploadedinfo").text("Pending Voucher !!!");
                $("#statusModal").modal('hide');
        }

        });


        // File input change handler
        $(document).on("change", "#ExtendModal #fileInput", async function (e) {
        var filedom = $(this);
            var input = $(this);
            var files = input[0].files;

             e.preventDefault();
            var parameters = {
            CustomerId: parseInt($("#custid").val()),
            ProductId: parseInt($("#prodid").val()),
        };
        var requestVoucherEntry = await AjaxCall("/CustomerPlanDetails/GetVoucherEntryStatus", parameters);
        var jsResponse = JSON.parse(requestVoucherEntry);
        var jsonData = JSON.parse(jsResponse);

        if (jsonData[0]["Status"] === 200) {

            // Check if any file is selected
            if (files.length === 0) {
                alert("Please select a file to upload.");
                return;
            }

            var formData = new FormData();
            for (var i = 0; i < files.length; i++) {
                formData.append("files", files[i]); // Append the file with key 'files'
            }

            await $.ajax({
                url: "/Register/UploadPhoto1", // Your controller endpoint
                data: formData,
                processData: false,    // Don't process the data
                contentType: false,    // Let the browser set the content type
                type: "POST",
                beforeSend: function () {
                    Swal.fire({
                        html: '<div class="loader" id="loader-6">' +
                            '<span></span>' +
                            '<span></span>' +
                            '<span></span>' +
                            '<span></span>' +
                            '</div>' +
                            '<div>' +
                            '<p style="color:#fff; font-size:20px;">PLEASE WAIT...</p>' +
                            '</div>',
                        background: 'unset',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                    });
                },
                success: function (data) {
                    console.log(data);
                    var imgName = data;
                    $(filedom).attr("data-filename", imgName);
                    $(filedom).parents(".gethere").find(".uploadedinfo").text("Uploaded !!!");
                    Swal.close();
                },
                error: function (error) {
                    Swal.close();
                    console.log(error);
                    $(filedom).parents(".gethere").find(".uploadedinfo").text("Upload Failed !!!");
           }
            });
            }
            else{
                toastr.error("Pending Voucher!!!");
            }
        });

            // File upload logic (reuses existing functionality)
    async function handleFileUpload(files) {
        $("#upload").attr("checked", true);

            const formData = new FormData();

            for (let i = 0; i < files.length; i++) {
                formData.append("files", files[i]);
            }

            await $.ajax({
                url: "/Register/UploadPhoto1",
                data: formData,
                processData: false,
                contentType: false,
                type: "POST",
                beforeSend: function () {
                    Swal.fire({
                        html: `<div class="loader" id="loader-6">
                                <span></span>
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <div>
                                <p style="color:#fff; font-size:20px;">PLEASE WAIT...</p>
                            </div>`,
                        background: "unset",
                        allowOutsideClick: false,
                        showConfirmButton: false,
                    });
                },
                success: function (data) {
                    console.log(data);
                    const imgName = data;
                    $uploadArea.attr("data-filename", imgName);
                    $uploadArea.find(".uploadedinfo").text("Uploaded !!!");
                    Swal.close();
                },
                error: function (error) {
                    Swal.close();
                    console.error(error);
                    $uploadArea.find(".uploadedinfo").text("Upload Failed !!!");
                },
            });

    }
    });


    $(".Products").on("change", function () {
        $("#showButton").trigger('click');
    });

    $("#showButton").on("click", function () {
        getTableData();
    });

    function getProducts() {
        var paa = AjaxCallWithoutDataNoAsync("/Products/getProducts");
        var aaha = JSON.parse(paa);
        var jsonD = JSON.parse(aaha);

        var ProductsD = "";
        if (jsonD.length > 0) {
            for (var a = 0; a < jsonD.length; a++) {
                ProductsD += `<option value="${jsonD[a]['Id']}">${jsonD[a]['Name']} (V .${jsonD[a]['Version']})</option>`;
            }
            $(".Products").not(".default").append(ProductsD);
        } else {
            toastr.error("No Products have been added!!!");
        }
    }

    async function getTableData() {
        var parm = {
            ProductId: parseInt($(".Products :selected").val())
        };
       
        var a = await AjaxCall("/Customer/getCustomerByProductId", parm);
        var ab = JSON.parse(a);
        var jsondata = JSON.parse(ab);
        var tableDOM = "";

        if (jsondata.length > 0) {
            for (var i = 0; i < jsondata.length; i++) {
                tableDOM += `<tr data-id="${jsondata[i]['Id']}" data-email=` + jsondata[i]["UserEmail"] + ` data-phone=` + jsondata[i]["UserContact"] + `>
                                    <td class="center"><b>${i + 1}.</b></td>
                                        <td class="center">
                                         <button style="background-color:#1ABC9C;" data-productName="${jsondata[i]['ProductName']}" data-productid="${jsondata[i]['ProductId']}" data-custid="${jsondata[i]['Id']}" class=" SelectModules hideme btn btn-sm btn-warning" data-bs-toggle="modal"  data-target="#exampleModal">
                                         Plan &nbsp;<i class="feather icon-check-square"></i>
                                         </button>
                                         <button data-type="${jsondata[i]['Type']}" data-bs-toggle="modal" data-bs-target="#statusModal" class="hideforagent viewSub btn btn-sm btn-danger" data-productName="${jsondata[i]['ProductName']}" data-productid="${jsondata[i]['ProductId']}" data-custid="${jsondata[i]['Id']}">Status&nbsp; <i class="feather icon-eye"></i></button>
                                         <button data-type="${jsondata[i]['Type']}" data-bs-toggle="modal" data-bs-target="#ExtendModal" class="hideforinsoft ExtendSub btn btn-sm btn-danger" data-productName="${jsondata[i]['ProductName']}" data-productid="${jsondata[i]['ProductId']}" data-custid="${jsondata[i]['Id']}">Extend&nbsp; <i class="feather icon-credit-card"></i></button>
                                        </td>
                                    <td class="center custCode">${jsondata[i]['Customercode']}</td>
                                    <td class="center custName">${jsondata[i]['CustomerName']}</td>
                                    <td class="center initial">${jsondata[i]['initial']}</td>
                                    <td class="center prodName">${jsondata[i]['ProductName']}</td>
                                    <td class="center custAdd">${jsondata[i]['Address']}</td>
                                    <td class="center custPANVAT">${jsondata[i]['pan/vatno']}</td>
                                    <td class="center custContact">${jsondata[i]['Contact']}</td>
                                    
                                </tr>`;
            }
            $("#agentTable tbody").empty().append(tableDOM);
          
             if ('@ViewBag.Role.ToString()' === "Agent") {
                $("#agentTable").find(".hideforagent").hide();
             }else if('@ViewBag.Role.ToString()' === "Insoft"){
                $("#agentTable").find(".hideforinsoft").hide();
             }
        } else {


            $("#agentTable tbody").empty().append(`
                    <tr class="center">
                        <td colspan="8">
                            <img src="/files/assets/images/nodataFound.jpg" alt="No data found" style="max-width: 100%; height: auto;">
                                <p style="color:red; font-size:22px;"><b>No Customers have been registered under this Product.</b></p>
                        </td>
                    </tr>
                `);
        }
    }

    $(document).on('click', '.SelectModules', function () {
        $('#exampleModal').modal('show');
        var id = $(this).attr("data-custid");
        var ProductId = $(this).attr("data-productid");
        var ProductName = $(this).attr("data-productName");
        $(".Customerr").text($(this).parents("tr").find(".custName").text());
        loadSubscriptionTypes(id, ProductId);
        $(".selectedProduct").text(ProductName);
        
    });

    async function loadSubscriptionTypes(CustomerId, ProductId) {
        $("#custid").val(CustomerId);
        $("#prodid").val(ProductId);
        var parm = {
            CustomerId: parseInt(CustomerId),
            ProductId: parseInt(ProductId)
        };
        var para = await AjaxCall("/Customer/getSubsbyCusandProductIdAdminInsoft", parm);
        var data = JSON.parse(para);
        var Jsondata = JSON.parse(data);
        if (Jsondata.length > 0) {
            var DOM = ``;
            for (var i = 0; i < Jsondata.length; i++) {
                var isChecked = Jsondata[i]["IsFound"] === "found" ? "checked" : "";
                DOM += `<tr data-subCusid="${Jsondata[i]['Id']}" data-substypeid="${Jsondata[i]['SubscriptionId']}">
                                <td class="center"><input type="checkbox" class="CheckPlan" ${isChecked}></td>
                                <td class="center">${Jsondata[i]['Name']}</td>
                            </tr>`;
            }
            $("#exampleModal").find("#modalTable tbody").empty().append(DOM);
        } else {
            toastr.error("No Subscription Setup is done!!!");
        }
    }

      //get the organisation subscription log
        $(document).on('click', '.ExtendSub', async function () {
            $("#ExtendModal").find(".userEmail").text($(this).parents("tr").find(".custName").text());
            $("#ExtendModal").find(".productN").text($(this).parents("tr").find(".prodName").text());

             var Type = $(this).attr("data-type");
        if(Type=='Desktop'){
            $("#ExtendModal").find(".DivMachine").css("display", "block");
        }
        else{
             $("#ExtendModal").find(".MachineKey").val("Online");
            $("#ExtendModal").find(".DivMachine").css("display", "none");
        }
            var CustomerId = $(this).attr("data-custid");
            var ProductId = $(this).attr("data-productid");
            $("#custid").val(CustomerId);
            $("#prodid").val(ProductId);
            await loadsubscriptionLogExtend(CustomerId, ProductId);
            await loadplansforcustomerandproductExtend(CustomerId, ProductId)

        });

        //get the organisation subscription log
        async function loadsubscriptionLogExtend(CustomerId, ProductId) {
            
            var parm = {
                CustomerId: parseInt(CustomerId),
                ProductId: parseInt(ProductId)
            };
            var jsub = await AjaxCall("/CustomerPlanDetails/getSubscriptionLogByCustandprodId", parm);
            var sub = JSON.parse(jsub);
            var jsonData = JSON.parse(sub);

            var subDOM = "";
            if (jsonData.length > 0) {
                for (var i = 0; i < jsonData.length; i++) {
                    
                    subDOM += `<tr>
                    <td class="center"><b>`+(i+1)+`</b></td>
                    <td class="center"><button class="btn btn-danger PrintLog" data-ukid="`+jsonData[i]["ukid"]+`"><i class="fas fa-print"></i></button></td>
                    <td class="center">`+ jsonData[i]["fonepayTraceId"] + `</td>
                                            <td class="center">`+ jsonData[i]["productName"] + `</td>
                                            <td class="center">`+ jsonData[i]["SubscriptionPlan"] + `</td>
                                            <td class="center">`+ jsonData[i]["IssuedDate"] + `</td>
                                            <td class="center">`+ jsonData[i]["ExpireDate"] + `</td>
                                            <td class="center">`+ jsonData[i]["Remarks"] + `</td>
                                            <td class="center">`+ jsonData[i]["PaymentRemarks"] + `</td>
                                            <td class="center">`+ jsonData[i]["PaymentMethod"] + `</td>
                                            <td class="center">`+ jsonData[i]["PaymentPartner"] + `</td>
                                            <td class="center">`+ jsonData[i]["PaidAmount"] + `</td>
                                            <td class="center">`+ jsonData[i]["ReferenceId"] + `</td>
                                            <td class="center hideme">`+ jsonData[i]["MachineKey"] + `</td>
                                            <td class="center">`+ jsonData[i]["Licensekey"] + `</td>

                                        `;
                }
                $("#ExtendModal").find("#cLogTableExtend tbody").empty().append(subDOM);
            } else {
                toastr.error("No Log Found!!!");
                $("#ExtendModal").find("#cLogTableExtend tbody").empty().append(`<tr><td colspan="9" class="center"><span class="red" style="font-size:24px;">No Log Found !!!</span></td></tr>`);
            }
        }
        //fill the form to extend the plan
        async function loadplansforcustomerandproductExtend(CustomerId, ProductId) {
            
            $(".currentPlan").text('----None---');
            $(".currentPlanEdate").text('__//__//____');
            $(".remainingDaysinCPlan").text('0');
            $(".TotalDaysInCurrentPlan").text('0');

            var parm = {
                CustomerId: parseInt(CustomerId),
                ProductId: parseInt(ProductId)
            };
            // Fetch current plan details
            var ddd = await AjaxCall("/CustomerPlanDetails/getCurrentPlan", parm);
            var response = JSON.parse(ddd);
            var responsefr = JSON.parse(response);

            if (responsefr[0]["ErrorMessage"] == -202) {
                toastr.error("You are not subscribed to the subscription Plan yet!!!");

            } else {
                if (responsefr.length > 0) {
                    // If a current plan exists
                    $("#ExtendModal").find(".MachineKey").val(responsefr[0]["MachineKey"]);
                    $(".currentPlan").text(responsefr[0]["CurrentlySubscription"]);

                    $(".currentPlanEdate").text(responsefr[0]["CurrentSubExpiryDate"]);
                    var remainingDays =  parseInt(responsefr[0]["RemainingDays"]);
                    var totalDays = parseInt(responsefr[0]["TotalDaysofPlan"]);
                    $(".remainingDaysinCPlan").text(remainingDays);
                    $(".TotalDaysInCurrentPlan").text(totalDays);

                     $("#ExtendModal").find("#NextDueDate").text(responsefr[0]["CurrentSubExpiryDate"]);
                     $("#ExtendModal").find("#CurrentPlan").text(responsefr[0]["CurrentlySubscription"]);

                } else {
                   
                }
            }
            // New/existing plan logic
           // var para = await AjaxCall("/Customer/getSubsbyCusandProductId", parm);        ---------------this fetches all the plans ------------dont delete this code---------

           var para=await AjaxCall("/Customer/getSubsbyCusandProductIdAdmin", parm);
           var data = JSON.parse(para);
            var Jsondata = JSON.parse(data);
            if (Jsondata.length > 0) {
                var selectDOM = ``;
                for (var i = 0; i < Jsondata.length; i++) {
                    //if (Jsondata[i]["IsFound"] == "found") {
                        var noOfDays = parseInt(Jsondata[i]["NoOfMonth"]);
                        var today = new Date();
                        var expireDate = new Date(today);
                        expireDate.setDate(today.getDate() + noOfDays + parseInt($("#ExtendModal .remainingDaysinCPlan").text())); // Modify expireDate directly
                        var isoExpireDate = expireDate.toISOString().split('T')[0]; // "YYYY-MM-DD"

                        $("#ExtendModal").find(".expiryDate").val(isoExpireDate);
                        //$("#statusModal").find(".Amount").val(Jsondata[i]["Amount"]);


                        selectDOM += `<option value="${Jsondata[i]["id"]}" data-noday=${noOfDays} data-expiredate=${isoExpireDate} amount=${Jsondata[i]['Amount']}>${Jsondata[i]['Name']}</option>`;
                   // }
                }
                $("#ExtendModal").find(".selectedPackages").empty().append(selectDOM);

                var firstOption = $("#ExtendModal").find(".selectedPackages option:first");
                     if (firstOption.length > 0) {
                         var defaultAmount = firstOption.attr("amount");
                         var defaultExpiryDate = firstOption.attr("data-expiredate");

                         $("#ExtendModal").find(".Amount").val(defaultAmount);
                         amountFetchedFromServer=parseFloat(defaultAmount);
                         $("#ExtendModal").find(".expiryDate").val(defaultExpiryDate);
                     }
                     } else {
                         toastr.error("No Subscription Setup is done!!!");
                     }
        }











    $(document).on('click', '.btn-saveSubs', async function () {
        let savePromises = []; 

        $("#modalTable tbody tr").each(async function () {
            
            const isChecked = $(this).find('input[type="checkbox"]').is(':checked');
            const parm = {
                Id: parseInt($(this).attr("data-subCusid")) , 
                CustomerId: parseInt($("#custid").val()),
                ProductId: parseInt($("#prodid").val()),
                AgentId: parseInt($(this).attr("data-substypeid")),
                Active: isChecked 
            };
            savePromises.push(parm);
        });
        const savePromise =await AjaxCall("/Subscription/SubsbyCustProdandType", savePromises);
        if(savePromise>0){
            $("#custid").val('');
            $("#prodid").val('');
            $("#exampleModal").modal('hide');
            toastr.success("Operation Successfull!!!");
            getTableData();
        }
        else
        {
            toastr.error("Operation Not Success!!!");
        }
    });

    $(".search").off("keyup").on("keyup", function () {
        var $rows = $('.table tbody tr');
        var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
        $rows.show().filter(function () {
            var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
            return !~text.indexOf(val);
        }).hide();
    });
        $(document).on('click', '.viewSub', function () {
        var id = $(this).attr("data-custid");
        var ProductId = $(this).attr("data-productid");

        var Type = $(this).attr("data-type");
       
        if(Type=='Desktop'){
            $("#statusModal").find(".DivMachine").css("display", "block");
        }
        else{
             $("#statusModal").find(".MachineKey").val("Online");
            $("#statusModal").find(".DivMachine").css("display", "none");
        }

        var ProductName = $(this).attr("data-productName");

        $(".Customerr").text($(this).parents("tr").find(".custName").text());
        $(".selectedProduct").text(ProductName);

        var userEmail = $(this).parents("tr").attr("data-email");
        $("#statusModal").find(".userEmail").text(userEmail);
        $("#statusModal").find(".userPhone").text($(this).parents("tr").attr("data-phone"));

        $("#custid").val(id);
        $("#prodid").val(ProductId);

        // Function to update amount and expiry date
        function updateAmountAndExpiry() {
           var selectedOption = $("#statusModal").find(".selectedPackages option:selected");
            var noOfDays = parseInt(selectedOption.attr("data-noday")) || 0;
            var amountInPlan = parseFloat(selectedOption.attr("data-amount")) || 0;

            var today = new Date();
            var expireDate = new Date(today);
            expireDate.setDate(today.getDate() + noOfDays + parseInt($(".remainingDaysinCPlan").text()));

            var isoExpireDate = expireDate.toISOString().split('T')[0];
            $("#statusModal").find(".expiryDate").val(isoExpireDate);

            if (noOfDays === 3 || noOfDays === 7) {
                $("#statusModal").find(".Amount").val('0').prop('disabled', true);
            } else {
                $("#statusModal").find(".Amount").val(amountInPlan).prop('disabled', true);
            }
        }

        loadplansforcustomerandproduct(id, ProductId).then(() => {
            updateAmountAndExpiry(); 
        });
        loadsubscriptionLog(id, ProductId);
        $("#statusModal").find(".selectedPackages").off("change").on("change", function () {
            updateAmountAndExpiry();
        });
    });

    async function loadplansforcustomerandproduct(CustomerId, ProductId) {
        
        $(".currentPlan").text('----None---');
        $(".currentPlanEdate").text('__//__//____');
        $(".remainingDaysinCPlan ").text('0');
        $(".TotalDaysInCurrentPlan ").text('0');

        var parm = {
            CustomerId: parseInt(CustomerId),
            ProductId: parseInt(ProductId)
        };


        var ddd = await AjaxCall("/CustomerPlanDetails/getCurrentPlan", parm);
        var response = JSON.parse(ddd);
        var responsefr = JSON.parse(response);
        if (responsefr.length > 0) {
            $("#statusModal").find(".MachineKey").val(responsefr[0]["MachineKey"]);
            $(".currentPlan").text(responsefr[0]["CurrentlySubscription"]);
            $(".currentPlanEdate").text(responsefr[0]["CurrentSubExpiryDate"]);
            $(".remainingDaysinCPlan ").text(responsefr[0]["RemainingDays"]);
            $(".TotalDaysInCurrentPlan ").text(responsefr[0]["TotalDaysofPlan"]);
        }

        var para = await AjaxCall("/Customer/getSubsbyCusandProductIdWithUnpaidType", parm);
        var data = JSON.parse(para);
        var Jsondata = JSON.parse(data);
        if (Jsondata.length > 0) {
            var selectDOM = ``;
            for (var i = 0; i < Jsondata.length; i++) {
                if (Jsondata[i]["IsFound"] == "found") {
                    var noOfDays = parseInt(Jsondata[i]["NoOfMonth"]);
                    var today = new Date();
                    var expireDate = new Date(today);
                    expireDate.setDate(today.getDate() + noOfDays + parseInt($("#statusModal .remainingDaysinCPlan").text()));
                    var isoExpireDate = expireDate.toISOString().split('T')[0]; // "YYYY-MM-DD"

                    selectDOM += `<option
                                    data-noday=${noOfDays}
                                    data-expiredate=${isoExpireDate}
                                    data-amount=${Jsondata[i]["Amount"]}
                                    value=${Jsondata[i]['SubscriptionId']}>
                                    ${Jsondata[i]['Name']}
                                 </option>`;
                }
            }
            $("#statusModal").find(".selectedPackages").empty().append(selectDOM);
        } else {
            toastr.error("No any Plan is given !!!");
        }
    }


    async function loadsubscriptionLog(CustomerId, ProductId){
        var parm = {
            CustomerId: parseInt(CustomerId),
            ProductId: parseInt(ProductId)
        };
   
        var jsub = await AjaxCall("/CustomerPlanDetails/getSubscriptionLogByCustandprodId",parm);
        var sub = JSON.parse(jsub);
        var jsonData = JSON.parse(sub);
        
        var subDOM = "";
        if (jsonData.length>0) {
            for (var i = 0; i < jsonData.length;i++) {
                subDOM += `<tr>
                <td class="center">`+(i+1)+`</td>
                                <td class="center">`+ jsonData[i]["productName"] + `</td>
                                <td class="center">`+ jsonData[i]["SubscriptionPlan"] + `</td>
                                <td class="center" style="color:green;"><b>Rs. `+ jsonData[i]["PaidAmount"] + `</b></td>
                                <td class="center">`+ jsonData[i]["IssuedDate"] + `</td>
                                <!--<td class="center"> `+ jsonData[i]["LastRenewDate"] + `  </td>-->
                                <td class="center">`+ jsonData[i]["ExpireDate"] + `</td>
                                <td class="center">`+ jsonData[i]["MachineKey"] + `</td>
                                <td class="center">`+ jsonData[i]["Remarks"] + `</td>
                                <td class="center">`+ jsonData[i]["PaymentMethod"] + `</td>
                                <td class="center">`+ jsonData[i]["PaymentPartner"] + `</td>
                                <td class="center">`+ jsonData[i]["GeneratedSerialNo"] + `</td>
                            `;
            }
            $("#statusModal").find("#cLogTable tbody").empty().append(subDOM);
        }else{
            toastr.error("No Log Found!!!");
            $("#statusModal").find("#cLogTable tbody").empty().append(`<tr><td colspan="9" class="center"><span class="red" style="font-size:24px;">No Log Found !!!</span></td></tr>`);
        }
    }

    $(document).on('click', '#ExtendModal .btnExtendPlan', async function (e) {
        debugger
              e.preventDefault();
            var paymentSelected = $('#ExtendModal input[name="payment"]:checked').length > 0;
            if (!paymentSelected) {
                toastr.warning('Please select a payment method before proceeding.', 'Warning');
                $(this).attr("checked",false);
                return;
            }
            if ($("#ExtendModal .rem").val() == "") {
                toastr.warning("Please fill in a Remarks!!!");
                  $(this).attr("checked",false);
                return;
            }
            else if ($("#ExtendModal #fileInput").attr("data-filename") == "") {
                toastr.warning("Please attach a voucher or pay through QR!!!");
                  $(this).attr("checked",false);
                return;
            }
            else if($("#ExtendModal").find(".MachineKey").val()==""){
                toastr.warning("Please Enter a Machine Key");
                  $(this).attr("checked",false);
                return;
            }
            else {
                var parm = {
                    SubscriptionType: parseInt($("#ExtendModal").find(".selectedPackages :selected").val()),
                    ExpiryDate: $("#ExtendModal").find(".selectedPackages :selected").attr("data-expiredate"),
                    PaidAmount: parseFloat($("#ExtendModal").find(".Amount").val()),
                    Remarks: $("#ExtendModal").find(".rem").val(),
                    CustomerId: parseInt($("#custid").val()),
                    ProductId: parseInt($("#prodid").val()),
                    TransactionId: 0,
                    PaymentMethod: 'cash',
                    ReferenceId: 0,
                    PaymentPartner: 'none',
                    GeneratedSerialNo: 'sn001',
                    VoucherImage:  $("#ExtendModal").find("#fileInput").attr("data-filename"),   // '930930471930930471-1543-sagar1_bg.jpg',
                    IsVerifiedPayment: 0,
                    Machinekey:$("#ExtendModal").find(".MachineKey").val()||"Online"
                }
                //insert the extension manually
                var cpp = await AjaxCall("/CustomerPlanDetails/InsertUpdate", parm);
                if (cpp!='Success') {
                      toastr.error("Plan extension  not successful");
                }
                else {
                    toastr.success("Plan extension successful");
                      $("#ExtendModal").modal('hide');
                }
            }
        });

    $(document).on('click', '#statusModal .btnExtendPlan', async function (event) {
        debugger
        event.preventDefault(); 
        if ($("#statusModal .rem").val() == "") {
            toastr.error("Please fill in a Remarks!!!");
        } else {
                $("#statusModal").modal('hide');
            // Prepare necessary data for InsertUpdate
            var Product = $("#statusModal").find(".selectedProduct").text();
            var Amount = parseFloat($("#statusModal").find(".Amount").val());
            var newExpDate = $("#statusModal").find(".selectedPackages :selected").attr("data-expiredate");
            var PlanName = $("#statusModal").find(".selectedPackages :selected").text();

            var parm = {
                SubscriptionType: parseInt($("#statusModal").find(".selectedPackages :selected").val()),
                ExpiryDate: newExpDate,
                PaidAmount: Amount,
                Remarks: $("#statusModal").find(".rem").val(),
                CustomerId:parseInt($("#custid").val()),
                ProductId:parseInt($("#prodid").val()),
                TransactionId:0,
                PaymentMethod:'admin',
                IsVerifiedPayment:1,
                ReferenceId:0,
                PaymentPartner:'none',
                GeneratedSerialNo:'sn001',
                VoucherImage: null,
                MachineKey:$("#statusModal").find(".MachineKey").val()
            };

            try {
                var cpp = await AjaxCall("/CustomerPlanDetails/InsertUpdate", parm);
                if (cpp == 'Success') {
                    //--------------------- Send SMS on successful extension of the subscription plan --------------------
                    var smsParm = {
                        SMS_Message: `Your subscription of ${Product} has been extended with a ${PlanName} Plan amounting to Rs.${Amount}. The plan will expire on ${newExpDate}`,
                        MobileNo: $("#statusModal").find(".userPhone").text()
                    };
                    // Send SMS
                    var successmsg = await AjaxCall("/Dashboard/SendSMS", smsParm);
                    var jsondata = JSON.parse(successmsg);

                    //------------------------- Send Email on successful extension --------------------
                    var emailBody = `
                        <div style="margin: 0; padding: 0; background-color: #f8f9fa;">
                            <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 36px 20px; font-family: Arial, sans-serif; color: #333;">
                                <div style="text-align: center;">
                                    <img src="https://incloud.academeplus.com/fileuploads/Subscription/703445501703445501-1543-LogoInsoft.png" alt="Insoft" style="max-width: 100%; height: auto;">
                                </div>
                                <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #000;">Subscription Extension Confirmation</h2>
                                <p style="font-size: 16px; font-weight: 400; margin-bottom: 20px;">Dear Valued Customer,</p>

                                <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                    We are pleased to inform you that your subscription to the <strong>${Product}</strong> product has been successfully extended.
                                    Below are the details of your extended subscription:
                                </p>

                                <table style="width: 100%; border: 1px solid #ddd; border-collapse: collapse; margin-bottom: 20px;">
                                    <tr style="background-color: #f4f4f4; text-align: left;">
                                        <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Subscription Plan</th>
                                        <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Amount Paid</th>
                                        <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Expiry Date</th>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${PlanName}</td>
                                        <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${Amount}</td>
                                        <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${newExpDate}</td>
                                    </tr>
                                </table>

                                <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                    The new expiry date for your subscription is <strong>${newExpDate}</strong>.
                                    If you have any questions or require further assistance, feel free to contact us at 061-543815.
                                </p>

                                <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                    Thank you for choosing us. We appreciate your continued trust and look forward to serving you.
                                </p>

                                <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                    Best regards, <br>
                                    Insoft Research & Development
                                </p>
                            </div>
                        </div>`;

                    // Prepare the email data
                    const toUser = {
                        ReceiverEmail: $("#statusModal").find(".userEmail").text(),
                        Subject: "Subscription Extended",
                        EmailBody: emailBody,
                    };

                    // Send Email
                    var successEmail = await AjaxCall("/Dashboard/SendEmail", toUser);

                    // Reset form fields after successful processing
                    $("#statusModal").find(".selectedProduct").text('');
                    $("#statusModal").find(".Amount").val('');
                    $("#statusModal").find(".rem").val('');
                    $("#statusModal").find(".selectedPackages :selected").text('');
                    $("#statusModal").find(".selectedPackages :selected").attr("data-expiredate", '');

                    // Notify the user of success
                    toastr.success("Subscription Extension Successful!!!");

                    // Close the modal
                    $("#statusModal").modal('hide');

                    // Refresh the table data
                    getTableData();
                } else {
                    toastr.error("Something went wrong with the subscription extension.");
                }
            } catch (error) {
                console.error("Error during AjaxCall:", error);
                toastr.error("An error occurred during the process.");
            }
        }
    });
     // Payment method change event
        $('#ExtendModal input[name="payment"]').change(async function (event) {
                 var $fileUpload = $('#file-upload');
                var $qrCode = $('#qr-code');
                var $fileInput = $('#fileInput');
                var $fileError = $('#fileError');
                event.preventDefault();
                     if ($(this).attr('id') === 'upload') {
                          $("#upload").attr("checked",true);
                        $fileUpload.show();
                        $qrCode.hide();
                    } else if ($(this).attr('id') === 'fonepay') {
            if ($(".rem").val() == "") {
                $(this).attr("required", true);
                toastr.error("Please enter a remarks before proceeding to payment!!!");
            } else {
                if ($('#fonepay').is(':checked')) {
                    var amount = parseFloat($("#ExtendModal").find(".Amount").val());


                    // Check if the fetched amount from the frontend matches the server amount
                    if (parseFloat(amountFetchedFromServer) !== amount) {
                        toastr.error("The amount fetched from the server and the amount from the frontend are not equal!!!");
                        return;  // Exit the function if amounts do not match
                    }

                    // Proceed only if the amounts are the same
                    var Product = $("#ExtendModal").find(".productN").text();
                    var Amount = parseFloat($("#ExtendModal").find(".Amount").val());
                    var newExpDate = $("#ExtendModal").find(".selectedPackages :selected").attr("data-expiredate");
                    var PlanName = $("#ExtendModal").find(".selectedPackages :selected").text();

                        if (amount) {
                        var bankDetails = {
                            amount: parseFloat(amountFetchedFromServer),
                            Purpose: "Live",
                            Remarks1: $("#ExtendModal").find(".rem").val(),
                            Remarks2: "Insoft Subscription"
                        };

                        // Call the backend to generate QR code and get the PRN
                        var aahaha = await AjaxCall("/QRCodeForPayment/FonePayProceed", bankDetails);
                        var response = JSON.parse(aahaha);
                          $("#ExtendModal").modal('hide');

                        $("#QRModal").modal('show');

                        // Ensure response contains hashKey and prn
                        if (response && response.prn && response.hashKey) {
                            var prn = response.prn;
                            $("#QRModal").find("#AmountQr").text(amount);

                            var hashKey = response.hashKey;
                            var qrMessage = response.qrMessage;

                            // Clear any existing QR code before generating a new one
                            $("#generated-qr").empty();

                            // Generate the QR code
                            new QRCode($("#QRModal").find("#generated-qr")[0], {
                                text: qrMessage,
                                width: 250,
                                height: 250,
                                colorDark: "#000000",
                                colorLight: "#ffffff",
                                correctLevel: QRCode.CorrectLevel.H
                            });

                                var $qrCode = $("#QRModal").find("#generated-qr-container");
                                 $qrCode.show();

                            // Flag to check if payment has been successfully processed
                            var paymentSuccessHandled = false;

                            // Start checking payment status every 2 seconds for this specific transaction (by prn)
                            var paymentStatusInterval = setInterval(async function () {
                                var getQRresponse = await AjaxCallNoAsync("/QRCodeForPayment/GetPaymentStatus", { qrHashKey: hashKey, prn: prn });
                                var paymentResponse = JSON.parse(getQRresponse);

                                if (paymentResponse[0]["paymentStatus"] === 'success' && !paymentSuccessHandled) {
                                    paymentSuccessHandled = true;

                                    // Handle successful payment, update database, send SMS/email, etc.
                                    var parm = {
                                        SubscriptionType: parseInt($("#ExtendModal").find(".selectedPackages :selected").val()),
                                        ExpiryDate: newExpDate,
                                        PaidAmount: parseFloat(paymentResponse[0]["totalTransactionAmount"]),
                                        Remarks: $("#ExtendModal").find(".rem").val(),
                                        CustomerId: parseInt($("#custid").val()),
                                        ProductId: parseInt($("#prodid").val()),
                                        TransactionId: 0,
                                        PaymentMethod: 'QR',
                                        ReferenceId: 0,
                                        PaymentPartner: 'FonePay',
                                        GeneratedSerialNo: 'sn001',
                                        VoucherImage: null,
                                        fonepayTraceId: parseInt(paymentResponse[0]["fonepayTraceId"]),
                                        IsVerifiedPayment: 1,
                                        Machinekey:$("#ExtendModal").find(".MachineKey").val()||"Online"
                                    };

                            var cpp = await AjaxCall("/CustomerPlanDetails/InsertUpdate", parm);

                            if (cpp != 'Success') {
                                toastr.error("Server side problem in extending the Plan");
                            } else {

                                try {
                                                     var invoiceData = {
                                                                  InvoiceDate: new Date().toLocaleDateString(),
                                                                  DueDate: new Date(newExpDate).toLocaleDateString(),
                                                                  CustomerName: $("#ExtendModal").find(".userPhone").text() || "",
                                                                  CustomerAddress: "Pokhara, Simalachaur, Pokhara, Mid Western, 44204, Nepal",
                                                                  Product: Product.toString(),
                                                                  PlanName: PlanName.toString(),
                                                                  Amount: paymentResponse[0]["totalTransactionAmount"].toString(),    /// changed from Amount to paymentResponse[0]["totalTransactionAmount"].toString() after hosting , needs to be tested
                                                                  TransactionId: paymentResponse[0]["fonepayTraceId"].toString(),
                                                                  PaymentGateway: "FonePay",
                                                                  TotalAmount: paymentResponse[0]["totalTransactionAmount"].toString(),
                                                                  Vat: (paymentResponse[0]["totalTransactionAmount"] * 0.13).toFixed(2),
                                                                  Subtotal: (paymentResponse[0]["totalTransactionAmount"] - (paymentResponse[0]["totalTransactionAmount"] * 0.13)).toFixed(2)
                                                              };
                                            var reqInvoice1 = await AjaxCall("/Home/CreateInvoice", invoiceData);
                                            var haha=JSON.parse(reqInvoice1);

                                          if (haha.success) {
                                           window.location.href = "/Home/InvoicePage";
                                           //    window.open("/Home/InvoicePage", "_blank");   window.open("/Home/InvoicePage", "_blank");
                                          }

                                    toastr.success("Subscription Extension Successful!!!");
                                    $("#ExtendModal").find(".rem").val('');
                                    $("#QRModal").modal('hide');
                                } catch (error) {
                                    toastr.error("An error occurred while generating the invoice.");
                                }

                                    // Send success SMS to the user
                                    var parm = {
                                        SMS_Message: `Your subscription of ${Product} has been extended with a ${PlanName} Plan of Rs.${Amount}.The next due date is on ${newExpDate}. Thank you for choosing Insoft R & D.`,
                                        MobileNo: $("#ExtendModal").find(".userPhone").text()
                                    };

                                    var successmsg = await AjaxCall("/Dashboard/SendSMS", parm);

                                    // Send confirmation email to the user
                                        const codeBody = `<div style="margin: 0; padding: 0; background-color: #f8f9fa;">
                                                <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 36px 20px; font-family: Arial, sans-serif; color: #333;">
                                                    <div style="text-align: center;">
                                                        <img src="https://incloud.academeplus.com/fileuploads/Subscription/703445501703445501-1543-LogoInsoft.png" alt="Insoft" style="max-width: 100%; height: auto;">
                                                    </div>
                                                    <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #000;">Subscription Extension Confirmation</h2>
                                                    <p style="font-size: 16px; font-weight: 400; margin-bottom: 20px;">Dear Valued Customer,</p>
                                                    <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                        We are pleased to inform you that your subscription to the <strong>${Product}</strong> product has been successfully extended.
                                                        Below are the details of your extended subscription:
                                                    </p>
                                                    <table style="width: 100%; border: 1px solid #ddd; border-collapse: collapse; margin-bottom: 20px;">
                                                        <tr style="background-color: #f4f4f4; text-align: left;">
                                                            <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Subscription Plan</th>
                                                            <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Amount Paid</th>
                                                            <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Next Due Date</th>
                                                        </tr>
                                                        <tr>
                                                            <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${PlanName}</td>
                                                            <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${Amount}</td>
                                                            <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${newExpDate}</td>
                                                        </tr>
                                                    </table>
                                                    <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                        The next due date of your subscription is <strong>${newExpDate}</strong>.
                                                        If you have any questions or require further assistance, feel free to contact us at 061-543815.
                                                    </p>
                                                    <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                        Thank you for choosing us. We appreciate your continued trust and look forward to serving you.
                                                    </p>
                                                    <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                        Best regards, <br>
                                                        Insoft Research & Development
                                                    </p>
                                                </div>
                                            </div>`;
                                    const toUser = {
                                        ReceiverEmail: $("#ExtendModal").find(".userEmail").text(),
                                        Subject: "Subscription Extended",
                                        EmailBody: codeBody,
                                    };

                                    var successEmail = await AjaxCall("/Dashboard/SendEmail", toUser);

                                    // Send email to Insoft team
                                        const insoftEmailBody = `<div style="margin: 0; padding: 0; background-color: #f8f9fa;">
                                                <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 36px 20px; font-family: Arial, sans-serif; color: #333;">
                                                    <div style="text-align: center;">
                                                        <img src="https://incloud.academeplus.com/fileuploads/Subscription/703445501703445501-1543-LogoInsoft.png" alt="Insoft" style="max-width: 100%; height: auto;">
                                                    </div>
                                                    <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #000;">Payment Successful - Subscription Extension</h2>
                                                    <p style="font-size: 16px; font-weight: 400; margin-bottom: 20px;">Dear Team,</p>
                                                    <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                        The subscription of the <strong>${Product}</strong> product has been successfully extended by the Customer themselves through the FonePay QR provided in our Software..
                                                        Below are the details of the transaction:
                                                    </p>
                                                    <table style="width: 100%; border: 1px solid #ddd; border-collapse: collapse; margin-bottom: 20px;">
                                                        <tr style="background-color: #f4f4f4; text-align: left;">
                                                            <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Subscription Plan</th>
                                                            <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Amount Paid</th>
                                                            <th style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">Expiry Date</th>
                                                        </tr>
                                                        <tr>
                                                            <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${PlanName}</td>
                                                            <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${Amount}</td>
                                                            <td style="padding: 10px; font-size: 14px; border-bottom: 1px solid #ddd;">${newExpDate}</td>
                                                        </tr>
                                                    </table>
                                                    <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                        The customer is now subscribed to the new plan until <strong>${newExpDate}</strong>.
                                                    </p>
                                                    <p style="font-size: 14px; font-weight: 400; margin-bottom: 20px;">
                                                        Best regards, <br>
                                                        Insoft Research & Development
                                                    </p>
                                                </div>
                                            </div>`;
                                    const toInsoft = {
                                        ReceiverEmail: "insoftrnd@gmail.com",
                                        Subject: "Payment Successful - Subscription Extension",
                                        EmailBody: insoftEmailBody,
                                    };

                                    var insoftEmail = await AjaxCall("/Dashboard/SendEmail", toInsoft);
                                    await GetOrganizations();
                                        }

                                    }
                            }, 2000); // Poll every 2 seconds

                            // Stop payment status polling when modal is closed or loses focus
                            $('#QRModal').on('hidden.bs.modal', function () {

                                clearInterval(paymentStatusInterval);
                                $("#ExtendModal").find(".rem").val('');
                                $("#ExtendModal").find("#upload").attr("checked", false);
                                $("#generated-qr-container").find("#generated-qr").empty();
                            });

                        } else {
                            $qrCode.hide();
                        }
                    } else {
                        $qrCode.hide();
                    }
                } else {
                    // Handle other cases if needed
                }
            }
        }
    });
    $(document).on("change", ".CheckPlan", function () {
        if ($(this).is(":checked")) {
            $(".CheckPlan").not(this).prop("checked", false);
        }
    });

   
</script>
